# NexusAI Enterprise Platform 技术白皮书

> **项目代号**: NexusAI Enterprise  
> **版本**: V7.3 Pro Final  
> **发布日期**: 2025年12月  
> **文档密级**: 内部公开

---

## 摘要

**NexusAI Enterprise Platform** 是一套面向中大型企业的新一代智能业务中台，深度融合 CRM（客户关系管理）、ERP（企业资源计划）与 AI Agent（智能代理）三大核心能力。

本白皮书详细阐述了 NexusAI 的技术架构、设计理念、核心模块、实施方案及商业价值，旨在为企业数字化转型提供一套完整、可落地、可扩展的智能化解决方案。

**核心价值主张**：
- 🎯 **一体化平台**：CRM + ERP + AI 深度融合，消除信息孤岛
- 🤖 **AI 原生架构**：不是"加个AI功能"，而是"AI 驱动一切"
- 💰 **成本可控**：多模型路由策略，智能选择最优性价比模型
- 🔧 **高度可定制**：模块化设计，按需组合，灵活扩展

---

## 目录

1. [市场背景与行业痛点](#1-市场背景与行业痛点)
2. [产品定位与核心价值](#2-产品定位与核心价值)
3. [技术架构设计](#3-技术架构设计)
4. [AI Agent 核心引擎](#4-ai-agent-核心引擎)
5. [业务功能模块](#5-业务功能模块)
6. [安全与合规](#6-安全与合规)
7. [部署方案](#7-部署方案)
8. [投资回报分析](#8-投资回报分析)
9. [实施路线图](#9-实施路线图)
10. [附录](#10-附录)

---

## 1. 市场背景与行业痛点

### 1.1 企业数字化转型现状

根据 Gartner 2024 年报告，全球企业数字化转型市场规模已达 **3.4 万亿美元**，预计 2027 年将突破 **5 万亿美元**。然而，数字化转型的成功率仅为 **30%**，主要原因包括：

| 痛点 | 占比 | 具体表现 |
|------|------|---------|
| 系统孤岛 | 45% | CRM、ERP、OA 各自独立，数据无法互通 |
| 重复劳动 | 32% | 大量人工录入、核对、汇总工作 |
| 决策滞后 | 28% | 报表周期长，无法实时掌握业务状态 |
| AI 落地难 | 67% | 买了 AI 产品，但无法与现有业务融合 |

### 1.2 传统 CRM/ERP 的局限性

```
┌─────────────────────────────────────────────────────────────────────┐
│                    传统企业软件的困境                                 │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   ┌─────────┐     ┌─────────┐     ┌─────────┐     ┌─────────┐     │
│   │  CRM    │     │  ERP    │     │   OA    │     │  BI     │     │
│   │  系统   │     │  系统   │     │  系统   │     │  报表   │     │
│   └────┬────┘     └────┬────┘     └────┬────┘     └────┬────┘     │
│        │              │              │              │            │
│        └──────────────┴──────────────┴──────────────┘            │
│                           │                                       │
│                    人工数据同步 😫                                 │
│                    效率低、易出错                                  │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

**传统方案的核心问题**：

1. **数据孤岛**：客户数据在 CRM，项目数据在 ERP，审批在 OA，三套账本
2. **响应迟缓**：月底才能出报表，决策永远慢半拍
3. **人工依赖**：工时估算靠经验，合同审查靠律师，报表靠 Excel
4. **AI 难落地**：买了 ChatGPT 企业版，但不知道怎么用

### 1.3 AI 时代的新机遇

2023-2025 年，大语言模型（LLM）技术突破性发展：

| 里程碑 | 时间 | 影响 |
|--------|------|------|
| GPT-4 发布 | 2023.03 | AI 能力质变，可处理复杂业务逻辑 |
| Function Calling | 2023.06 | AI 可调用外部工具，从"聊天"到"执行" |
| Deepseek V2 | 2024.05 | 成本降低 90%，中小企业可负担 |
| Agent 架构成熟 | 2024.12 | AI 可自主规划、执行、反馈 |

**这意味着**：AI 不再只是"智能客服"或"写文案"的工具，而是可以**真正参与业务决策和执行**的智能助手。

---

## 2. 产品定位与核心价值

### 2.1 产品定位

**NexusAI Enterprise** 的定位是：

> 🎯 **AI 原生的企业业务中台**
> 
> 不是在传统 CRM/ERP 上"加一个 AI 功能"，而是从底层架构开始，以 AI 为核心重新设计企业业务系统。

```
┌─────────────────────────────────────────────────────────────────────┐
│                      NexusAI 产品定位矩阵                            │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│         传统 CRM           NexusAI           传统 AI 产品           │
│            │                  │                  │                  │
│   ┌────────▼────────┐ ┌──────▼──────┐ ┌────────▼────────┐         │
│   │  功能导向       │ │  AI 原生    │ │  通用工具        │         │
│   │  数据录入为主   │ │  智能决策   │ │  与业务割裂      │         │
│   │  被动查询       │ │  主动提醒   │ │  无法执行操作    │         │
│   └─────────────────┘ └─────────────┘ └─────────────────┘         │
│                                                                     │
│   ← 功能完整但不智能    智能且功能完整    智能但功能缺失 →           │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 2.2 核心价值主张

#### 价值一：一体化平台，消除信息孤岛

| 传统方案 | NexusAI 方案 |
|---------|-------------|
| CRM、ERP、OA 三套系统 | 统一平台，一套账本 |
| 人工同步数据 | 实时数据流转 |
| 切换 5 个系统找信息 | 一句话问 AI |

#### 价值二：AI 驱动，从"记录"到"决策"

| 传统方案 | NexusAI 方案 |
|---------|-------------|
| 手动录入工时 | AI 自动估算工时 |
| 律师审查合同 | AI 秒速风险扫描 |
| 月底出报表 | 实时数据洞察 |
| 经验决策 | 数据 + AI 决策 |

#### 价值三：成本可控，智能模型路由

```
┌─────────────────────────────────────────────────────────────────────┐
│                    智能模型路由策略                                  │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   简单任务（日常对话、数据查询）                                     │
│   └──► Deepseek（成本: $0.001/1K tokens）                          │
│                                                                     │
│   中等任务（工时估算、报表分析）                                     │
│   └──► Deepseek / Qwen（成本: $0.002/1K tokens）                   │
│                                                                     │
│   复杂任务（合同审查、代码生成）                                     │
│   └──► OpenAI GPT-4（成本: $0.03/1K tokens）                       │
│                                                                     │
│   敏感数据（内部文档、财务数据）                                     │
│   └──► Ollama 本地部署（成本: $0 / 仅硬件）                        │
│                                                                     │
│   💡 通过智能路由，平均成本降低 70%                                 │
└─────────────────────────────────────────────────────────────────────┘
```

### 2.3 目标客户

| 客户类型 | 规模 | 典型需求 |
|---------|------|---------|
| 科技公司 | 50-500人 | 项目管理、工时统计、成本核算 |
| 咨询公司 | 20-200人 | 客户管理、合同管理、交付管理 |
| 制造企业 | 100-1000人 | 采购管理、供应商管理、预算控制 |
| 服务企业 | 30-300人 | 客户跟进、报价管理、结算管理 |

---

## 3. 技术架构设计

### 3.1 整体架构

NexusAI 采用 **CSM (Controller-Service-Model) + AI Agent** 分层架构：

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         NexusAI 系统架构                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                        表现层 (Presentation)                          │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  │ │
│  │  │  Web 前端   │  │  移动 APP   │  │  API 网关   │  │  WebHook    │  │ │
│  │  │  (Vue 3)    │  │  (Flutter)  │  │  (index.php)│  │  (回调)     │  │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘  │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                      │                                      │
│                                      ▼                                      │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                        控制层 (Controller)                            │ │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐        │ │
│  │  │  Auth   │ │ Project │ │Contract │ │   AI    │ │ Report  │  ...   │ │
│  │  │Controller│ │Controller│ │Controller│ │Controller│ │Controller│       │ │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘        │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                      │                                      │
│                                      ▼                                      │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                        服务层 (Service)                               │ │
│  │  ┌──────────────────────────────────────────────────────────────────┐│ │
│  │  │                    业务服务 (Business Services)                   ││ │
│  │  │  AuthService │ ProjectService │ ContractService │ ReportService  ││ │
│  │  └──────────────────────────────────────────────────────────────────┘│ │
│  │  ┌──────────────────────────────────────────────────────────────────┐│ │
│  │  │                    AI 服务 (AI Services)                         ││ │
│  │  │  ┌─────────────────────────────────────────────────────────────┐ ││ │
│  │  │  │                    AIManager (统一门面)                      │ ││ │
│  │  │  └─────────────────────────────────────────────────────────────┘ ││ │
│  │  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐   ││ │
│  │  │  │Pipeline │ │Providers│ │  Tools  │ │ Memory  │ │ Queue   │   ││ │
│  │  │  │ 流水线  │ │模型驱动 │ │ 工具箱  │ │记忆系统 │ │异步队列 │   ││ │
│  │  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘   ││ │
│  │  └──────────────────────────────────────────────────────────────────┘│ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                      │                                      │
│                                      ▼                                      │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                        数据层 (Model)                                 │ │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐        │ │
│  │  │  User   │ │ Project │ │Contract │ │  Task   │ │ AIJob   │  ...   │ │
│  │  │  Model  │ │  Model  │ │  Model  │ │  Model  │ │  Model  │        │ │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘        │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                      │                                      │
│                                      ▼                                      │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                        存储层 (Storage)                               │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  │ │
│  │  │   MySQL     │  │   Redis     │  │ VectorDB    │  │   文件存储   │  │ │
│  │  │  主数据库   │  │  缓存/队列  │  │  向量库     │  │  OSS/本地   │  │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘  │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 技术栈选型

| 层级 | 技术选型 | 选型理由 |
|------|---------|---------|
| **后端语言** | PHP 8.3 | 成熟稳定、开发效率高、人才充足 |
| **架构模式** | CSM | 前后端分离最佳实践，业务逻辑集中管理 |
| **数据库** | MySQL 8.0 | 企业级可靠性、JSON 支持、全文索引 |
| **缓存** | Redis 7.x | 高性能、支持队列、会话管理 |
| **向量库** | PgVector / Milvus | RAG 知识库检索、语义搜索 |
| **AI 模型** | Deepseek / OpenAI / Ollama | 多模型支持、成本优化、私有化部署 |
| **前端** | Vue 3 + TypeScript | 现代化、组件化、类型安全 |
| **部署** | Docker + K8s | 容器化、弹性伸缩、高可用 |

### 3.3 CSM 架构详解

**为什么选择 CSM 而不是传统 MVC？**

```
┌─────────────────────────────────────────────────────────────────────┐
│                    MVC vs CSM 对比                                  │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   传统 MVC                          CSM (Controller-Service-Model) │
│   ─────────                          ─────────────────────────────  │
│                                                                     │
│   Controller ────► Model            Controller ────► Service ────► Model
│       │              │                   │              │              │
│       │              │                   │              │              │
│       └────► View ◄──┘               只处理请求      业务逻辑       纯SQL
│                                       参数验证       计算/判断
│                                       返回JSON       流程编排
│                                                                     │
│   问题：                              优点：                         │
│   • Controller 臃肿                   • 职责单一                     │
│   • 业务逻辑散落各处                  • 业务逻辑集中                  │
│   • 难以复用                          • Service 可被多入口调用       │
│   • 难以测试                          • 易于单元测试                  │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

**CSM 的核心优势**：

1. **Controller 只做路由**：接收请求、参数校验、调用 Service、返回响应
2. **Service 承载业务**：所有业务逻辑集中在 Service 层，可被 API、Worker、CLI 复用
3. **Model 纯数据**：只做 SQL 操作，不包含业务判断
4. **天然适配 AI**：AI 模块本身就是一个复杂的 Service

---

## 4. AI Agent 核心引擎

### 4.1 AI 模块架构概览

NexusAI 的 AI 引擎是整个系统的**智能核心**，采用**模块化、可插拔**的设计：

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         AI Agent 引擎架构                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│                        ┌─────────────────────┐                              │
│                        │     AIManager       │                              │
│                        │    (统一门面)        │                              │
│                        └──────────┬──────────┘                              │
│                                   │                                         │
│         ┌─────────────────────────┼─────────────────────────┐               │
│         ▼                         ▼                         ▼               │
│  ┌─────────────┐          ┌─────────────┐          ┌─────────────┐         │
│  │  Pipeline   │          │   Tasks     │          │   Queue     │         │
│  │  (流水线)   │          │ (预设任务)   │          │ (异步队列)   │         │
│  └──────┬──────┘          └─────────────┘          └─────────────┘         │
│         │                                                                   │
│         ▼                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        Pipeline Pipes (处理工序)                     │   │
│  ├─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬────────┤   │
│  │ 0_限流  │ 1_安全  │ 2_记忆  │ 3_工具  │ 4_模型  │ 5_执行  │ 6_保存 │   │
│  └─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴────────┘   │
│                                   │                                         │
│         ┌─────────────────────────┼─────────────────────────┐               │
│         ▼                         ▼                         ▼               │
│  ┌─────────────┐          ┌─────────────┐          ┌─────────────┐         │
│  │  Providers  │          │   Tools     │          │   Memory    │         │
│  │ (模型驱动)  │          │  (工具箱)   │          │ (记忆系统)  │         │
│  ├─────────────┤          ├─────────────┤          ├─────────────┤         │
│  │ • Deepseek  │          │ • DB查询    │          │ • 短期记忆  │         │
│  │ • OpenAI    │          │ • 邮件发送  │          │ • 摘要记忆  │         │
│  │ • Ollama    │          │ • 报表生成  │          │ • 向量记忆  │         │
│  │ • Embedding │          │ • 合同查询  │          │             │         │
│  └─────────────┘          └─────────────┘          └─────────────┘         │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 4.2 核心组件详解

#### 4.2.1 AIManager - 统一门面

**AIManager** 是 AI 模块的**唯一对外入口**，采用 Facade 设计模式：

```php
// 使用示例
$result = AIManager::run('worktime_estimate', [
    'requirement' => '开发用户登录模块，包含验证码功能',
    'complexity' => 'medium'
]);

// 流式输出
AIManager::stream('chat', $input, function($chunk) {
    echo $chunk;
});

// Agent 模式（自主调用工具）
$result = AIManager::agent('project_assistant')
    ->withTools(['database_query', 'email_sender'])
    ->withMemory('user-123')
    ->ask('这个项目的预算还剩多少？如果超支了发邮件给项目经理');
```

**设计理念**：
- 外部代码**只需要知道 AIManager**，不需要了解内部复杂结构
- 自动处理模型选择、限流、记忆、错误重试等逻辑
- 统一的日志和监控埋点

#### 4.2.2 Pipeline - 流水线处理

**Pipeline** 采用**洋葱模型**设计，每个请求依次经过多个处理工序：

```
请求 ──► 0_RateLimit ──► 1_SafetyCheck ──► 2_LoadMemory ──► 3_PlanTools
                                                                   │
响应 ◄── 7_FormatOutput ◄── 6_SaveMemory ◄── 5_ExecuteTool ◄── 4_CallModel
```

| Pipe | 职责 | 核心逻辑 |
|------|------|---------|
| **0_RateLimit** | 限流保护 | 基于 Redis 的令牌桶算法，防止 API 滥用 |
| **1_SafetyCheck** | 安全检查 | Prompt 注入检测、敏感词过滤 |
| **2_LoadMemory** | 加载记忆 | 获取历史对话、RAG 知识检索 |
| **3_PlanTools** | 工具规划 | 分析需要调用哪些工具 |
| **4_CallModel** | 模型调用 | 调用 LLM，支持降级重试 |
| **5_ExecuteTool** | 执行工具 | 执行 AI 选择的工具调用 |
| **6_SaveMemory** | 保存记忆 | 将对话存入记忆系统 |
| **7_FormatOutput** | 格式化输出 | 清洗 AI 返回的数据格式 |

**PipelineContext - 数据传输对象**：

```php
class PipelineContext
{
    public string $taskType;         // 任务类型
    public array $input;             // 原始输入
    public ?string $userId;          // 用户ID
    public array $messages = [];     // 对话消息
    public array $tools = [];        // 可用工具
    public array $toolCalls = [];    // 工具调用结果
    public mixed $rawResponse;       // 模型原始响应
    public mixed $finalResult;       // 最终结果
    public array $meta = [           // 元数据
        'start_time' => null,
        'total_tokens' => 0,
        'cost' => 0,
        'provider' => null,
    ];
}
```

#### 4.2.3 Providers - 多模型驱动

**多模型支持**是 NexusAI 的核心竞争力之一：

```
┌─────────────────────────────────────────────────────────────────────┐
│                      多模型路由策略                                  │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   ┌─────────────────────────────────────────────────────────────┐  │
│   │                    ModelRouter (路由器)                      │  │
│   │    根据 任务类型 + Token 预估 + 可用性 智能选择模型          │  │
│   └─────────────────────────────────────────────────────────────┘  │
│                              │                                      │
│         ┌────────────────────┼────────────────────┐                │
│         ▼                    ▼                    ▼                │
│   ┌───────────┐        ┌───────────┐        ┌───────────┐         │
│   │ Deepseek  │        │  OpenAI   │        │  Ollama   │         │
│   │  (主力)   │        │  (兜底)   │        │  (本地)   │         │
│   ├───────────┤        ├───────────┤        ├───────────┤         │
│   │成本: 极低 │        │成本: 较高 │        │成本: 免费 │         │
│   │能力: 优秀 │        │能力: 顶级 │        │能力: 良好 │         │
│   │场景: 日常 │        │场景: 复杂 │        │场景: 敏感 │         │
│   └───────────┘        └───────────┘        └───────────┘         │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

**模型选择策略**：

| 任务类型 | 默认模型 | 备选模型 | 选择理由 |
|---------|---------|---------|---------|
| 日常对话 | Deepseek | Qwen | 成本最低，响应快 |
| 工时估算 | Deepseek | OpenAI | 需要一定推理能力 |
| 合同审查 | OpenAI | Deepseek | 需要强逻辑能力 |
| 代码生成 | OpenAI | Deepseek | 需要精确输出 |
| 敏感数据 | Ollama | - | 数据不出内网 |

**自动降级机制**：

```php
// 当主模型不可用时，自动切换到备选模型
try {
    $result = $deepseekProvider->chat($messages);
} catch (ProviderException $e) {
    $this->logger->warning("Deepseek 不可用，降级到 OpenAI");
    $result = $openaiProvider->chat($messages);
}
```

#### 4.2.4 Tools - AI 工具箱

**Function Calling** 让 AI 不再只是"聊天"，而是可以**执行实际操作**：

```
┌─────────────────────────────────────────────────────────────────────┐
│                        AI 工具箱架构                                 │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   ┌─────────────────────────────────────────────────────────────┐  │
│   │                    ToolRegistry (注册中心)                   │  │
│   │              管理所有可用工具，生成 Schema                   │  │
│   └─────────────────────────────────────────────────────────────┘  │
│                              │                                      │
│   ┌──────────────────────────┼──────────────────────────┐          │
│   │                          │                          │          │
│   ▼                          ▼                          ▼          │
│ ┌──────────────┐      ┌──────────────┐      ┌──────────────┐      │
│ │ System Tools │      │Business Tools│      │  ToolSandbox │      │
│ │  (系统工具)  │      │ (业务工具)   │      │  (安全沙箱)  │      │
│ ├──────────────┤      ├──────────────┤      ├──────────────┤      │
│ │• DatabaseReader│    │• ContractFinder│    │ 权限检查     │      │
│ │• HttpSearch   │     │• EmailSender  │     │ 调用频率限制 │      │
│ │• TimeCalculator│    │• ReportBuilder│     │ 结果过滤     │      │
│ └──────────────┘      └──────────────┘      └──────────────┘      │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

**工具定义示例**：

```php
class DatabaseReader extends BaseTool
{
    public function getName(): string { return 'database_query'; }
    
    public function getDescription(): string {
        return '执行只读 SQL 查询，获取项目、合同、任务等业务数据';
    }
    
    public function getParameters(): array {
        return [
            'type' => 'object',
            'properties' => [
                'query' => [
                    'type' => 'string',
                    'description' => 'SQL 查询语句（只允许 SELECT）'
                ]
            ],
            'required' => ['query']
        ];
    }
    
    public function execute(array $params): mixed {
        // 安全检查：只允许 SELECT
        if (!preg_match('/^\s*SELECT/i', $params['query'])) {
            throw new \Exception('只允许 SELECT 查询');
        }
        
        return DB::get()->query($params['query'])->fetchAll();
    }
}
```

**安全沙箱机制**：

| 权限级别 | 允许操作 | 对应角色 |
|---------|---------|---------|
| LEVEL_READONLY | 数据查询 | 所有用户 |
| LEVEL_WRITE | 发邮件、创建任务 | 项目经理 |
| LEVEL_DANGEROUS | 数据修改、删除 | 管理员 |

#### 4.2.5 Memory - 三级记忆系统

AI 的**记忆能力**决定了对话的连贯性和智能程度：

```
┌─────────────────────────────────────────────────────────────────────┐
│                      三级记忆架构                                    │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   ┌─────────────────────────────────────────────────────────────┐  │
│   │                   ContextManager (组装器)                    │  │
│   │            智能组装三级记忆，构建完整上下文                   │  │
│   └─────────────────────────────────────────────────────────────┘  │
│                              │                                      │
│         ┌────────────────────┼────────────────────┐                │
│         ▼                    ▼                    ▼                │
│   ┌───────────┐        ┌───────────┐        ┌───────────┐         │
│   │ ShortTerm │        │  Summary  │        │VectorStore│         │
│   │ (短期记忆)│        │(摘要记忆) │        │(长期记忆) │         │
│   ├───────────┤        ├───────────┤        ├───────────┤         │
│   │存储: Redis│        │存储: MySQL│        │存储: 向量库│         │
│   │TTL: 24小时│        │容量: 无限 │        │容量: 无限 │         │
│   │内容: 原文 │        │内容: 压缩 │        │内容: 向量 │         │
│   │用途: 当前 │        │用途: 历史 │        │用途: 知识 │         │
│   │     会话  │        │     摘要  │        │     检索  │         │
│   └───────────┘        └───────────┘        └───────────┘         │
│                                                                     │
│   💡 通过三级记忆，AI 既能记住刚才说的，也能回忆以前的，            │
│      还能检索海量知识库                                             │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

**记忆组装流程**：

```
1. 系统人设 (固定)
   └─► "你是 NexusAI 企业助手，擅长项目管理、工时估算..."

2. RAG 知识检索 (VectorStore)
   └─► 根据问题，检索相关的合同条款、历史项目经验等

3. 历史摘要 (Summary)
   └─► "上次对话，用户询问了项目 A 的预算，我回答了..."

4. 近期对话 (ShortTerm)
   └─► 最近 10 轮对话的原文

5. 当前问题
   └─► 用户的本次提问
```

#### 4.2.6 Queue - 异步任务队列

对于**耗时较长**的 AI 任务（如合同审查、文档向量化），采用异步队列处理：

```
┌─────────────────────────────────────────────────────────────────────┐
│                      异步任务队列架构                                │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   用户请求                                                          │
│      │                                                              │
│      ▼                                                              │
│   ┌─────────────────┐     ┌─────────────────┐                      │
│   │ AIJobDispatcher │────►│    ai_jobs      │                      │
│   │   (任务分发)    │     │   (MySQL 表)    │                      │
│   └─────────────────┘     └────────┬────────┘                      │
│      │                             │                                │
│      │ 立即返回 job_id             │                                │
│      ▼                             │                                │
│   ┌─────────────────┐              │                                │
│   │  前端轮询状态   │              │                                │
│   └─────────────────┘              │                                │
│                                    │                                │
│                                    ▼                                │
│                         ┌─────────────────┐                        │
│                         │  AIJobWorker    │ (后台常驻进程)          │
│                         │   (队列消费)    │                        │
│                         └────────┬────────┘                        │
│                                  │                                  │
│               ┌──────────────────┼──────────────────┐              │
│               ▼                  ▼                  ▼              │
│        ┌───────────┐      ┌───────────┐      ┌───────────┐        │
│        │RunAgentJob│      │VectorizeDoc│     │ContractReview│       │
│        │ (通用Agent)│     │(文档向量化)│     │(合同审查)   │        │
│        └───────────┘      └───────────┘      └───────────┘        │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

**任务优先级**：

| 优先级 | 任务类型 | 说明 |
|--------|---------|------|
| 10 (最高) | 用户实时对话 | 用户在等待，优先处理 |
| 8 | 合同审查 | 用户等待审批结果 |
| 5 | 工时批量估算 | 批量任务，不急 |
| 3 | 文档向量化 | 后台慢慢跑 |
| 1 | 知识库同步 | 定时任务 |

### 4.3 RAG 知识库系统

**RAG (Retrieval-Augmented Generation)** 让 AI 能够基于企业私有数据回答问题：

```
┌─────────────────────────────────────────────────────────────────────┐
│                       RAG 知识库流程                                 │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   [文档入库阶段]                                                    │
│                                                                     │
│   PDF/Word/Excel ──► DocumentChunker ──► EmbeddingEngine ──► VectorStore
│                      (文档切片)          (生成向量)        (存储)   │
│                                                                     │
│   💡 关键优化：FileHasher 哈希去重                                  │
│      相同文件只向量化一次，节省 50%+ 成本                           │
│                                                                     │
│   ─────────────────────────────────────────────────────────────    │
│                                                                     │
│   [查询阶段]                                                        │
│                                                                     │
│   用户问题 ──► EmbeddingEngine ──► VectorStore ──► 相关文档片段     │
│              (问题向量化)        (相似度检索)                       │
│                      │                                              │
│                      ▼                                              │
│              ┌─────────────┐                                        │
│              │  LLM 模型   │                                        │
│              │ 基于检索结果 │                                        │
│              │  生成回答   │                                        │
│              └─────────────┘                                        │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

**应用场景**：

| 场景 | 知识库内容 | 效果 |
|------|-----------|------|
| 合同审查 | 历史合同、法规条款 | AI 可对照标准条款分析风险 |
| 工时估算 | 历史项目工时数据 | AI 可参考类似项目估算 |
| 客户服务 | 产品手册、FAQ | AI 可准确回答产品问题 |
| 新员工培训 | 公司制度、流程文档 | AI 可回答内部流程问题 |

### 4.4 成本控制与监控

**Analytics 模块**提供完整的成本控制和用量监控：

```
┌─────────────────────────────────────────────────────────────────────┐
│                      AI 成本监控仪表盘                               │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   📊 今日统计                                                       │
│   ├── 请求总数: 1,234                                               │
│   ├── 总 Token: 567,890                                             │
│   ├── 总成本: ¥12.34                                                │
│   ├── 平均延迟: 850ms                                               │
│   └── 成功率: 98.5%                                                 │
│                                                                     │
│   📈 模型分布                                                       │
│   ├── Deepseek: 80% (¥4.50)                                        │
│   ├── OpenAI: 15% (¥7.80)                                          │
│   └── Ollama: 5% (¥0.00)                                           │
│                                                                     │
│   🔔 告警规则                                                       │
│   ├── 单日成本 > ¥100 → 发送邮件告警                               │
│   ├── 错误率 > 10% → 发送钉钉告警                                  │
│   └── Token 用量暴涨 3x → 自动限流                                  │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 5. 业务功能模块

### 5.1 模块总览

NexusAI 包含 **16 个核心业务模块**：

```
┌─────────────────────────────────────────────────────────────────────┐
│                      NexusAI 业务模块矩阵                            │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   ┌─────────────────────────────────────────────────────────────┐  │
│   │                    CRM 客户关系管理                          │  │
│   │  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐        │  │
│   │  │ 客户管理 │  │ 联系人  │  │ 跟进记录 │  │  商机   │        │  │
│   │  └─────────┘  └─────────┘  └─────────┘  └─────────┘        │  │
│   └─────────────────────────────────────────────────────────────┘  │
│                                                                     │
│   ┌─────────────────────────────────────────────────────────────┐  │
│   │                    ERP 项目资源管理                          │  │
│   │  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐        │  │
│   │  │ 项目管理 │  │ 合同管理 │  │ 预算管理 │  │ 报价管理 │        │  │
│   │  └─────────┘  └─────────┘  └─────────┘  └─────────┘        │  │
│   │  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐        │  │
│   │  │ 需求管理 │  │ 任务管理 │  │ 工时管理 │  │ 结算管理 │        │  │
│   │  └─────────┘  └─────────┘  └─────────┘  └─────────┘        │  │
│   └─────────────────────────────────────────────────────────────┘  │
│                                                                     │
│   ┌─────────────────────────────────────────────────────────────┐  │
│   │                    财务与采购                                │  │
│   │  ┌─────────┐  ┌─────────┐                                   │  │
│   │  │ 费用报销 │  │ 采购管理 │                                   │  │
│   │  └─────────┘  └─────────┘                                   │  │
│   └─────────────────────────────────────────────────────────────┘  │
│                                                                     │
│   ┌─────────────────────────────────────────────────────────────┐  │
│   │                    系统支撑                                  │  │
│   │  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐        │  │
│   │  │ 用户管理 │  │ 角色权限 │  │ 报表中心 │  │ 打印服务 │        │  │
│   │  └─────────┘  └─────────┘  └─────────┘  └─────────┘        │  │
│   └─────────────────────────────────────────────────────────────┘  │
│                                                                     │
│   ┌─────────────────────────────────────────────────────────────┐  │
│   │                    🤖 AI 智能增强                            │  │
│   │  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐        │  │
│   │  │ 智能对话 │  │ 工时估算 │  │ 合同审查 │  │ 数据分析 │        │  │
│   │  └─────────┘  └─────────┘  └─────────┘  └─────────┘        │  │
│   └─────────────────────────────────────────────────────────────┘  │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 5.2 AI 赋能场景

#### 场景一：智能工时估算

**传统方式**：项目经理凭经验估算，误差率 30%-50%

**AI 方式**：

```
用户输入：
"开发用户登录模块，包含手机验证码、微信扫码、记住密码功能"

AI 分析过程：
1. 解析需求 → 识别出 3 个子功能点
2. 检索历史 → 找到 5 个类似项目的工时数据
3. 复杂度评估 → 判断为"中等复杂度"
4. 综合计算 → 输出工时估算

AI 输出：
┌────────────────────────────────────────────────────┐
│ 📊 工时估算报告                                    │
├────────────────────────────────────────────────────┤
│ 总预估工时: 24-32 人时                             │
│                                                    │
│ 明细拆分:                                          │
│ • 手机验证码登录: 8-10h (接口+前端+测试)           │
│ • 微信扫码登录: 10-12h (OAuth+回调+测试)           │
│ • 记住密码功能: 4-6h (Token+安全+测试)             │
│ • 集成联调: 2-4h                                   │
│                                                    │
│ 参考依据:                                          │
│ • 项目A 类似功能: 28h                              │
│ • 项目B 类似功能: 25h                              │
│ • 项目C 类似功能: 30h                              │
│                                                    │
│ 置信度: 85%                                        │
└────────────────────────────────────────────────────┘
```

#### 场景二：合同智能审查

**传统方式**：律师审查，耗时 2-3 天，成本 ¥2000-5000/份

**AI 方式**：

```
用户操作：上传合同 PDF

AI 分析过程：
1. 文档解析 → 提取合同文本
2. RAG 检索 → 匹配标准条款库、法规库
3. 风险识别 → 逐条分析潜在风险
4. 生成报告 → 输出审查意见

AI 输出：
┌────────────────────────────────────────────────────┐
│ 📋 合同审查报告                                    │
├────────────────────────────────────────────────────┤
│ 合同编号: HT-2025-001                              │
│ 合同类型: 软件开发服务合同                          │
│ 风险等级: ⚠️ 中等风险                              │
│                                                    │
│ 🔴 高风险条款 (2项):                               │
│ 1. 第5.3条 付款条件                                │
│    问题: 验收后 90 天付款，周期过长                 │
│    建议: 修改为验收后 30 天                         │
│                                                    │
│ 2. 第8.1条 知识产权                                │
│    问题: 未明确源代码归属                           │
│    建议: 增加源代码交付条款                         │
│                                                    │
│ 🟡 中风险条款 (3项):                               │
│ ...                                                │
│                                                    │
│ ✅ 合规条款 (15项)                                 │
│ ...                                                │
│                                                    │
│ 📊 相似合同参考:                                   │
│ • HT-2024-089 (相似度 92%)                         │
│ • HT-2024-056 (相似度 87%)                         │
└────────────────────────────────────────────────────┘
```

#### 场景三：自然语言数据查询

**传统方式**：找技术人员写 SQL，或等月报

**AI 方式**：

```
用户提问：
"上个月哪些项目超预算了？超了多少？"

AI 处理过程：
1. 理解意图 → 识别为"预算分析"查询
2. 规划工具 → 决定调用 database_query 工具
3. 生成 SQL → SELECT ... FROM projects JOIN budgets ...
4. 执行查询 → 获取原始数据
5. 分析总结 → 生成自然语言回答

AI 回答：
"上个月共有 3 个项目超预算：

1. 🔴 项目A - 超支 ¥45,000 (超出 23%)
   主要原因: 需求变更导致开发工时增加
   
2. 🟡 项目B - 超支 ¥12,000 (超出 8%)
   主要原因: 服务器采购价格上涨
   
3. 🟡 项目C - 超支 ¥5,000 (超出 3%)
   主要原因: 差旅费用超出预期

建议: 项目A 超支严重，建议与客户协商追加预算。"
```

---

## 6. 安全与合规

### 6.1 安全架构概览

NexusAI 采用**纵深防御**策略，从网络层到应用层提供多层安全保障：

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         安全防护架构                                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                        第一层：网络安全                              │  │
│   │  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐               │  │
│   │  │  WAF    │  │ DDoS防护│  │  SSL    │  │  VPN    │               │  │
│   │  │ Web防火墙│ │ 流量清洗│  │ 加密传输│  │ 内网隔离│               │  │
│   │  └─────────┘  └─────────┘  └─────────┘  └─────────┘               │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                      │                                      │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                        第二层：应用安全                              │  │
│   │  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐               │  │
│   │  │JWT认证  │  │ RBAC    │  │ CSRF    │  │SQL注入  │               │  │
│   │  │Token鉴权│  │ 权限控制│  │ 防护    │  │  防护   │               │  │
│   │  └─────────┘  └─────────┘  └─────────┘  └─────────┘               │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                      │                                      │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                        第三层：AI 安全                               │  │
│   │  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐               │  │
│   │  │Prompt   │  │敏感词   │  │工具沙箱 │  │输出过滤 │               │  │
│   │  │注入检测 │  │  过滤   │  │权限控制 │  │数据脱敏 │               │  │
│   │  └─────────┘  └─────────┘  └─────────┘  └─────────┘               │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                      │                                      │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                        第四层：数据安全                              │  │
│   │  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐               │  │
│   │  │数据加密 │  │访问审计 │  │备份恢复 │  │隐私保护 │               │  │
│   │  │AES-256  │  │操作日志 │  │灾备方案 │  │GDPR合规 │               │  │
│   │  └─────────┘  └─────────┘  └─────────┘  └─────────┘               │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 6.2 AI 特有安全机制

#### 6.2.1 Prompt 注入防护

**威胁场景**：恶意用户尝试通过特殊输入绕过 AI 限制

```
┌────────────────────────────────────────────────────────────────────┐
│ 🛡️ Prompt 注入检测                                                │
├────────────────────────────────────────────────────────────────────┤
│                                                                    │
│ 输入检测规则：                                                     │
│ • 角色劫持检测: "忽略之前的指令"、"你现在是..."                    │
│ • 指令注入检测: 特殊字符序列、系统指令关键词                        │
│ • 上下文污染检测: 伪造的对话历史                                   │
│                                                                    │
│ 防护措施：                                                         │
│ • 系统指令与用户输入隔离                                           │
│ • 输入预处理和转义                                                 │
│ • 异常模式告警                                                     │
│                                                                    │
└────────────────────────────────────────────────────────────────────┘
```

**实现代码示例**：

```php
class SafetyCheckPipe implements PipeInterface
{
    private array $injectionPatterns = [
        '/忽略.{0,10}(之前|上面|以上).{0,10}(指令|提示|规则)/u',
        '/你现在(是|扮演|变成)/u',
        '/\[SYSTEM\]/i',
        '/\{\{.*\}\}/',
    ];
    
    public function handle(PipelineContext $ctx, callable $next): mixed
    {
        $input = $ctx->input['message'] ?? '';
        
        foreach ($this->injectionPatterns as $pattern) {
            if (preg_match($pattern, $input)) {
                throw new SecurityException('检测到潜在的提示注入攻击');
            }
        }
        
        return $next($ctx);
    }
}
```

#### 6.2.2 工具调用安全沙箱

**分级权限控制**：

| 安全级别 | 允许的工具 | 适用场景 |
|---------|-----------|---------|
| **LEVEL_0** (只读) | database_query (SELECT only) | 数据查询、报表 |
| **LEVEL_1** (有限写) | email_sender, task_creator | 发邮件、创建任务 |
| **LEVEL_2** (敏感写) | data_modifier | 修改业务数据 |
| **LEVEL_3** (管理员) | system_command | 系统管理操作 |

**沙箱执行流程**：

```
工具调用请求
    │
    ▼
┌─────────────┐
│ 权限检查    │ ─── 用户是否有权限调用此工具？
└─────────────┘
    │
    ▼
┌─────────────┐
│ 参数验证    │ ─── 参数是否合法？是否包含危险内容？
└─────────────┘
    │
    ▼
┌─────────────┐
│ 频率限制    │ ─── 调用频率是否超限？
└─────────────┘
    │
    ▼
┌─────────────┐
│ 隔离执行    │ ─── 在受限环境中执行
└─────────────┘
    │
    ▼
┌─────────────┐
│ 结果过滤    │ ─── 脱敏处理、日志记录
└─────────────┘
```

#### 6.2.3 敏感数据处理

**本地模型部署**：对于涉及敏感数据的场景，自动路由到本地 Ollama 模型

```php
// 敏感数据识别规则
$sensitivePatterns = [
    '/身份证.{0,5}\d{15,18}/',           // 身份证号
    '/银行卡.{0,5}\d{16,19}/',           // 银行卡号
    '/密码|password/i',                   // 密码相关
    '/财务报表|利润|营收/',               // 财务数据
];

// 自动路由到本地模型
if ($this->containsSensitiveData($input)) {
    $provider = $this->providers['ollama'];  // 数据不出内网
}
```

### 6.3 合规性支持

| 法规/标准 | 合规措施 |
|----------|---------|
| **GDPR** | 数据最小化、用户数据导出/删除、同意管理 |
| **网络安全法** | 数据本地化、安全等级保护、日志留存 |
| **个人信息保护法** | 敏感信息加密、访问授权、隐私影响评估 |
| **等保 2.0** | 三级等保要求覆盖、安全审计 |

### 6.4 审计与监控

```
┌─────────────────────────────────────────────────────────────────────┐
│                      安全审计仪表盘                                  │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   📊 今日安全事件                                                   │
│   ├── 登录尝试: 1,234 (失败: 23)                                   │
│   ├── API 调用: 45,678                                             │
│   ├── AI 请求: 2,345                                               │
│   ├── 安全告警: 3                                                   │
│   └── 阻断攻击: 12                                                  │
│                                                                     │
│   🔔 最近告警                                                       │
│   ├── [高] 10:23 疑似SQL注入尝试 - IP: 1.2.3.4                     │
│   ├── [中] 09:45 异常登录行为 - 用户: admin                        │
│   └── [低] 08:30 API 调用频率超限 - 用户: user123                  │
│                                                                     │
│   📈 趋势分析                                                       │
│   └── [图表: 最近7天安全事件趋势]                                   │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 7. 部署方案

### 7.1 部署架构选型

NexusAI 支持多种部署方式，满足不同规模企业需求：

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         部署方案对比                                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                    方案A：单机部署 (小型企业)                        │  │
│   │                                                                     │  │
│   │    适用: 50人以下，预算有限                                         │  │
│   │    配置: 4核8G 云服务器 × 1                                         │  │
│   │    成本: ¥500/月                                                    │  │
│   │                                                                     │  │
│   │    ┌──────────────────────────────────────┐                        │  │
│   │    │           单台服务器                  │                        │  │
│   │    │  ┌─────────┐ ┌─────────┐ ┌────────┐ │                        │  │
│   │    │  │  Nginx  │ │  PHP    │ │ MySQL  │ │                        │  │
│   │    │  └─────────┘ └─────────┘ └────────┘ │                        │  │
│   │    │  ┌─────────┐ ┌─────────┐            │                        │  │
│   │    │  │  Redis  │ │ Worker  │            │                        │  │
│   │    │  └─────────┘ └─────────┘            │                        │  │
│   │    └──────────────────────────────────────┘                        │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                    方案B：高可用集群 (中型企业)                      │  │
│   │                                                                     │  │
│   │    适用: 50-500人，需要高可用                                       │  │
│   │    配置: 8核16G × 3 + 数据库主从                                    │  │
│   │    成本: ¥3000/月                                                   │  │
│   │                                                                     │  │
│   │           ┌─────────────┐                                          │  │
│   │           │  负载均衡   │                                          │  │
│   │           └──────┬──────┘                                          │  │
│   │        ┌─────────┼─────────┐                                       │  │
│   │        ▼         ▼         ▼                                       │  │
│   │    ┌───────┐ ┌───────┐ ┌───────┐                                  │  │
│   │    │ App-1 │ │ App-2 │ │ App-3 │                                  │  │
│   │    └───────┘ └───────┘ └───────┘                                  │  │
│   │        │         │         │                                       │  │
│   │        └─────────┴─────────┘                                       │  │
│   │                 │                                                   │  │
│   │    ┌───────────┴───────────┐                                       │  │
│   │    │  MySQL 主从 + Redis 集群 │                                    │  │
│   │    └───────────────────────┘                                       │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                    方案C：Kubernetes 云原生 (大型企业)              │  │
│   │                                                                     │  │
│   │    适用: 500人以上，弹性扩展                                        │  │
│   │    配置: K8s 集群 + 云数据库                                        │  │
│   │    成本: ¥10000+/月                                                 │  │
│   │                                                                     │  │
│   │    ┌─────────────────────────────────────────────────────────┐     │  │
│   │    │                    Kubernetes 集群                       │     │  │
│   │    │  ┌─────────────────────────────────────────────────┐    │     │  │
│   │    │  │  Ingress Controller                              │    │     │  │
│   │    │  └─────────────────────────────────────────────────┘    │     │  │
│   │    │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐       │     │  │
│   │    │  │ API Pod │ │ API Pod │ │Worker Pod│ │Worker Pod│ ...  │     │  │
│   │    │  └─────────┘ └─────────┘ └─────────┘ └─────────┘       │     │  │
│   │    │  ┌─────────────────────────────────────────────────┐    │     │  │
│   │    │  │  HPA (自动伸缩)                                  │    │     │  │
│   │    │  └─────────────────────────────────────────────────┘    │     │  │
│   │    └─────────────────────────────────────────────────────────┘     │  │
│   │                          │                                          │  │
│   │    ┌─────────────────────┴─────────────────────┐                   │  │
│   │    │  云数据库 RDS + 云Redis + 向量数据库服务   │                   │  │
│   │    └───────────────────────────────────────────┘                   │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 7.2 Docker 部署配置

**docker-compose.yml 示例**：

```yaml
version: '3.8'

services:
  # Nginx 反向代理
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./ssl:/etc/nginx/ssl
    depends_on:
      - php

  # PHP 应用
  php:
    build:
      context: .
      dockerfile: Dockerfile
    volumes:
      - ./api:/var/www/html/api
      - ./public:/var/www/html/public
    environment:
      - DB_HOST=mysql
      - REDIS_HOST=redis
      - AI_PROVIDER=deepseek
    depends_on:
      - mysql
      - redis

  # AI Worker
  worker:
    build:
      context: .
      dockerfile: Dockerfile.worker
    volumes:
      - ./api:/var/www/html/api
    environment:
      - DB_HOST=mysql
      - REDIS_HOST=redis
    depends_on:
      - mysql
      - redis
    restart: always

  # MySQL 数据库
  mysql:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
      MYSQL_DATABASE: nexusai
    volumes:
      - mysql_data:/var/lib/mysql
      - ./database/schema.sql:/docker-entrypoint-initdb.d/init.sql

  # Redis 缓存
  redis:
    image: redis:7-alpine
    volumes:
      - redis_data:/data

  # Ollama 本地模型 (可选)
  ollama:
    image: ollama/ollama
    volumes:
      - ollama_data:/root/.ollama
    deploy:
      resources:
        reservations:
          devices:
            - capabilities: [gpu]

volumes:
  mysql_data:
  redis_data:
  ollama_data:
```

### 7.3 性能优化配置

#### 7.3.1 PHP 优化

```ini
; php.ini 推荐配置
memory_limit = 512M
max_execution_time = 300
opcache.enable = 1
opcache.memory_consumption = 256
opcache.max_accelerated_files = 20000
opcache.validate_timestamps = 0
```

#### 7.3.2 MySQL 优化

```ini
# my.cnf 推荐配置
[mysqld]
innodb_buffer_pool_size = 4G
innodb_log_file_size = 512M
innodb_flush_log_at_trx_commit = 2
max_connections = 500
query_cache_type = 0
```

#### 7.3.3 Redis 优化

```conf
# redis.conf 推荐配置
maxmemory 2gb
maxmemory-policy allkeys-lru
```

### 7.4 监控与运维

**推荐监控栈**：

```
┌─────────────────────────────────────────────────────────────────────┐
│                      监控运维架构                                    │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   ┌───────────────────────────────────────────────────────────┐    │
│   │                    Grafana 仪表盘                          │    │
│   └───────────────────────────────────────────────────────────┘    │
│                              │                                      │
│         ┌────────────────────┼────────────────────┐                │
│         ▼                    ▼                    ▼                │
│   ┌───────────┐        ┌───────────┐        ┌───────────┐         │
│   │Prometheus │        │   Loki    │        │  Jaeger   │         │
│   │  (指标)   │        │  (日志)   │        │  (链路)   │         │
│   └───────────┘        └───────────┘        └───────────┘         │
│         │                    │                    │                │
│         └────────────────────┼────────────────────┘                │
│                              │                                      │
│   ┌───────────────────────────────────────────────────────────┐    │
│   │              应用服务 + AI Worker                          │    │
│   └───────────────────────────────────────────────────────────┘    │
│                                                                     │
│   关键监控指标:                                                     │
│   • API 响应时间 P99 < 500ms                                       │
│   • AI 请求成功率 > 99%                                            │
│   • Worker 队列积压 < 100                                          │
│   • 数据库连接池使用率 < 80%                                        │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

*（白皮书第三部分完成，请说"继续"查看最终章节：投资回报分析、实施路线图、附录）*
