# 崔哥 AI 记忆系统架构 V3

> 🆕 V3 新特性：智能上下文压缩（大厂级）

## 🧠 V3 智能压缩流程

```
┌─────────────────────────────────────────────────────────────────┐
│                    💡 智能压缩决策流程                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│   用户消息 ──→ 构建上下文 ──→ 📊 计算 Token 数                   │
│                                    │                             │
│                                    ▼                             │
│                         ┌──────────────────┐                     │
│                         │  Token < 70%?    │                     │
│                         │  (40K/57K)       │                     │
│                         └────────┬─────────┘                     │
│                                  │                               │
│                    ┌─────────────┴─────────────┐                │
│                    │ YES ✅            NO 🔴   │                │
│                    ▼                       ▼   │                │
│              正常发送              🤖 启动压缩AI │                │
│              到主AI                    │       │                │
│                                        ▼       │                │
│                              ┌─────────────────┐                │
│                              │ 📦 压缩旧对话    │                │
│                              │ ✍️ 生成精炼摘要  │                │
│                              │ 🔒 保留最近4条   │                │
│                              └────────┬────────┘                │
│                                       │                         │
│                                       ▼                         │
│                              💾 保存摘要到DB                     │
│                              🏷️ 标记已压缩消息                    │
│                                       │                         │
│                                       ▼                         │
│                              压缩后上下文发送到主AI              │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## 📊 模型参数配置

| 参数 | DeepSeek-V3 | 说明 |
|------|------------|------|
| 最大上下文 | 65,536 tokens | 约 32,000 中文字 |
| 预留输出 | 8,192 tokens | AI 回复空间 |
| 可用上下文 | 57,344 tokens | 实际可用空间 |
| 压缩阈值 | 70% (~40K) | 达到此比例触发压缩 |

## 🔢 Token 估算算法

```php
// 中文：约 1.5 字符 = 1 token
// 英文：约 4 字符 = 1 token
function estimateTokens($text) {
    $chineseCount = preg_match_all('/[\x{4e00}-\x{9fff}]/u', $text);
    $otherCount = mb_strlen($text) - $chineseCount;
    return (int)($chineseCount / 1.5 + $otherCount / 4);
}
```

## 🗜️ 压缩 Prompt 模板

```
请压缩以下对话记录，保留关键信息：
1. 用户基本信息（名字、工作等）
2. 对话主要内容和结论
3. AI 做出的承诺或建议
4. 用户表达的需求或偏好

保持简洁，控制在200字以内。
```

---

## 🧠 整体架构流程图（完整版）

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              用户发送消息                                          │
│                                  ↓                                               │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │                         cuige_api.php                                    │    │
│  │  ┌──────────────────────────────────────────────────────────────────┐   │    │
│  │  │ 1. 即时提取关键信息 extractAndSaveKeyInfo()                        │   │    │
│  │  │    • 正则匹配: 名字、年龄、工作、城市                               │   │    │
│  │  │    • 直接存入 → cuige_long_memory (source='user')                 │   │    │
│  │  └──────────────────────────────────────────────────────────────────┘   │    │
│  │                                  ↓                                       │    │
│  │  ┌──────────────────────────────────────────────────────────────────┐   │    │
│  │  │ 2. 保存到工作记忆 saveToShortMemory()                              │   │    │
│  │  │    • 用户消息 → cuige_short_memory (role='user')                  │   │    │
│  │  └──────────────────────────────────────────────────────────────────┘   │    │
│  │                                  ↓                                       │    │
│  │  ┌──────────────────────────────────────────────────────────────────┐   │    │
│  │  │ 3. 构建智能上下文 buildIntelligentContext()                        │   │    │
│  │  │    ┌─────────────────────────────────────────────────────────┐   │   │    │
│  │  │    │ System Prompt 组装:                                      │   │   │    │
│  │  │    │  ├─ 崔哥人设基础提示                                      │   │   │    │
│  │  │    │  ├─ 【用户画像】← cuige_user_profile                     │   │   │    │
│  │  │    │  ├─ 【用户信息】← cuige_long_memory (source='user')      │   │   │    │
│  │  │    │  ├─ 【AI自己说过的】← cuige_long_memory (source='ai')    │   │   │    │
│  │  │    │  └─ 【对话摘要】← cuige_episode_memory                   │   │   │    │
│  │  │    └─────────────────────────────────────────────────────────┘   │   │    │
│  │  │    ┌─────────────────────────────────────────────────────────┐   │   │    │
│  │  │    │ 对话历史:                                                │   │   │    │
│  │  │    │  └─ 最近10条消息 ← cuige_short_memory                   │   │   │    │
│  │  │    └─────────────────────────────────────────────────────────┘   │   │    │
│  │  └──────────────────────────────────────────────────────────────────┘   │    │
│  │                                  ↓                                       │    │
│  │  ┌──────────────────────────────────────────────────────────────────┐   │    │
│  │  │ 4. 调用 AI (DeepSeek)                                            │   │    │
│  │  │    messages[] → ModelRouter → AI 回复                            │   │    │
│  │  └──────────────────────────────────────────────────────────────────┘   │    │
│  │                                  ↓                                       │    │
│  │  ┌──────────────────────────────────────────────────────────────────┐   │    │
│  │  │ 5. 保存 AI 回复 saveToShortMemory()                               │   │    │
│  │  │    • AI回复 → cuige_short_memory (role='assistant')              │   │    │
│  │  └──────────────────────────────────────────────────────────────────┘   │    │
│  │                                  ↓                                       │    │
│  │  ┌──────────────────────────────────────────────────────────────────┐   │    │
│  │  │ 6. 提取 AI 记忆 extractAIResponseMemory()                         │   │    │
│  │  │    • AI 分析自己的回复                                            │   │    │
│  │  │    • 提取: 承诺、建议、计划、关键信息                              │   │    │
│  │  │    • 存入 → cuige_long_memory (source='ai')                      │   │    │
│  │  └──────────────────────────────────────────────────────────────────┘   │    │
│  │                                  ↓                                       │    │
│  │  ┌──────────────────────────────────────────────────────────────────┐   │    │
│  │  │ 7. 触发后台任务 triggerMemoryTask()                               │   │    │
│  │  │    • 插入任务 → cuige_memory_tasks (待 Worker 处理)              │   │    │
│  │  └──────────────────────────────────────────────────────────────────┘   │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│                                  ↓                                               │
│                           返回 AI 回复给用户                                      │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 📊 数据库表结构

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                            记忆层级 (Memory Hierarchy)                           │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│   ┌─────────────────────┐                                                       │
│   │  🔴 工作记忆 (L1)    │  cuige_short_memory                                  │
│   │  短期 · 高精度       │  ────────────────────────                            │
│   │                     │  • session_id: 会话ID                                 │
│   │  保留: 最近10条      │  • user_id: 用户ID                                   │
│   │  生命周期: 当前会话   │  • role: user/assistant                             │
│   │                     │  • content: 完整消息内容                              │
│   │                     │  • is_summarized: 是否已压缩                          │
│   │                     │  • created_at: 创建时间                               │
│   └──────────┬──────────┘                                                       │
│              │ 压缩                                                              │
│              ↓                                                                   │
│   ┌─────────────────────┐                                                       │
│   │  🟡 情景记忆 (L2)    │  cuige_episode_memory                                │
│   │  中期 · 摘要级       │  ────────────────────────                            │
│   │                     │  • session_id: 会话ID                                 │
│   │  保留: 最近20个摘要   │  • user_id: 用户ID                                   │
│   │  生命周期: 数天~数周  │  • summary: 对话摘要                                 │
│   │                     │  • key_points: 关键要点 (JSON)                        │
│   │                     │  • emotional_tone: 情绪基调                           │
│   │                     │  • importance_score: 重要性评分                       │
│   └──────────┬──────────┘                                                       │
│              │ 提取                                                              │
│              ↓                                                                   │
│   ┌─────────────────────┐                                                       │
│   │  🟢 语义记忆 (L3)    │  cuige_long_memory                                   │
│   │  长期 · 事实级       │  ────────────────────────                            │
│   │                     │  • user_id: 用户ID                                    │
│   │  保留: 永久          │  • category: 分类 (名字/工作/AI建议...)              │
│   │  生命周期: 永久      │  • subject: 主题摘要                                  │
│   │                     │  • content: 详细内容                                  │
│   │  来源区分:           │  • source: 'user' 或 'ai'                            │
│   │  • user: 用户信息    │  • importance: 重要性 1-10                           │
│   │  • ai: AI的承诺/建议 │  • mention_count: 提及次数                           │
│   │                     │  • is_active: 是否有效                                │
│   └─────────────────────┘                                                       │
│                                                                                  │
│   ┌─────────────────────┐                                                       │
│   │  🔵 用户画像         │  cuige_user_profile                                  │
│   │  长期 · 特征级       │  ────────────────────────                            │
│   │                     │  • user_id: 用户ID                                    │
│   │  保留: 永久          │  • personality_traits: 性格特征                       │
│   │  生命周期: 永久      │  • communication_style: 沟通风格                      │
│   │  AI 分析生成         │  • interests: 兴趣爱好                               │
│   │                     │  • last_updated: 更新时间                             │
│   └─────────────────────┘                                                       │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## ⏰ 记忆持久性分析

### 当前系统记忆能力

| 记忆类型 | 存储位置 | 保留时长 | 触发条件 | 状态 |
|---------|---------|---------|---------|------|
| **工作记忆** | cuige_short_memory | 最近 **10条** 消息 | 每次对话 | ✅ 已实现 |
| **用户事实** | cuige_long_memory (source=user) | **永久** | 正则匹配提取 | ✅ 已实现 |
| **AI 记忆** | cuige_long_memory (source=ai) | **永久** | AI 分析提取 | ✅ 已实现 |
| **对话摘要** | cuige_episode_memory | 最近 **3条** 摘要 | 后台 Worker | ⚠️ Worker未运行 |
| **用户画像** | cuige_user_profile | **永久** | 后台 Worker | ⚠️ Worker未运行 |

---

## 🎯 实际记忆能力总结

### ✅ 能记住的（永久）：

```
1. 用户基本信息（通过正则即时提取）:
   • 名字: "我叫张伟" → 永久记住
   • 年龄: "我28岁" → 永久记住
   • 工作: "我是程序员" → 永久记住
   • 城市: "我在上海" → 永久记住

2. AI 自己说过的重要内容（通过 AI 分析提取）:
   • 承诺: "我帮你查一下" → 永久记住
   • 建议: "建议你早睡早起" → 永久记住
   • 计划: "下次我们继续聊这个" → 永久记住
```

### ⏳ 能记住的（短期）：

```
3. 当前对话上下文:
   • 最近 10 条消息 → 只在当前会话有效
   • 超过 10 条后，旧消息不会出现在上下文中
```

### ❌ 当前不会记住的：

```
4. 复杂语义信息（需要后台 Worker）:
   • "我喜欢吃火锅" → 正则匹配不到，需要 AI 提取
   • "我老婆叫小红" → 正则匹配不到
   • 对话摘要、用户画像 → Worker 未运行
```

---

## 📈 记忆流程时序图

```
时间轴 ─────────────────────────────────────────────────────────────→

用户说: "我叫张伟，在上海做程序员"
     │
     ▼
┌────────────────────────────────────────────────────────────────┐
│ 即时处理 (毫秒级)                                               │
│                                                                │
│  正则提取 ──┬─→ 名字:张伟 ───→ cuige_long_memory (永久)         │
│            ├─→ 城市:上海 ───→ cuige_long_memory (永久)         │
│            └─→ 工作:程序员 ──→ cuige_long_memory (永久)         │
│                                                                │
│  保存消息 ────→ cuige_short_memory (最近10条)                   │
└────────────────────────────────────────────────────────────────┘
     │
     ▼
┌────────────────────────────────────────────────────────────────┐
│ AI 处理                                                        │
│                                                                │
│  构建上下文 ←─── 读取长期记忆 + 工作记忆                         │
│       ↓                                                        │
│  调用 DeepSeek ──→ AI 生成回复                                 │
│       ↓                                                        │
│  保存回复 ────→ cuige_short_memory                             │
│       ↓                                                        │
│  AI 分析回复 ──→ 提取承诺/建议 ──→ cuige_long_memory (永久)     │
└────────────────────────────────────────────────────────────────┘
     │
     ▼
┌────────────────────────────────────────────────────────────────┐
│ 后台处理 (Worker - 当前未运行)                                  │
│                                                                │
│  ❌ 压缩旧消息 ──→ cuige_episode_memory                        │
│  ❌ 生成用户画像 ──→ cuige_user_profile                         │
│  ❌ 复杂语义提取 ──→ cuige_long_memory                         │
└────────────────────────────────────────────────────────────────┘
```

---

## 🔧 提升建议

### 1. 启动后台 Worker（提升记忆能力）

```bash
# 在 WSL 中运行
cd /mnt/h/Desktop/RUST/CRM_AI_V7
php workers/memory_worker_v3.php &
```

### 2. 增强即时提取的正则（当前覆盖有限）

当前只能提取：名字、年龄、工作、城市

建议增加：
- 家人关系: `/我(?:老婆|老公|儿子|女儿|爸|妈)(?:叫|是)([^\s，。]{2,8})/`
- 爱好: `/我(?:喜欢|爱好|经常)([^\s，。]{2,15})/`
- 生日: `/我(?:生日|出生)(?:是)?(\d{1,2}月\d{1,2})/`

### 3. 增加工作记忆窗口

当前：10条消息
建议：20-30条，或按 token 数量限制

---

## 📊 总结

| 维度 | 当前能力 | 说明 |
|------|---------|------|
| **短期记忆** | 10条消息 | 足够支持单轮对话连贯性 |
| **用户信息** | 永久 | 但只能提取4种基本信息 |
| **AI自我记忆** | 永久 | 能记住自己说的承诺/建议 |
| **复杂语义** | ❌ 未启用 | 需要启动 Worker |
| **跨会话** | ✅ 支持 | 通过长期记忆实现 |

**一句话总结：当前系统能永久记住用户的名字、年龄、工作、城市，以及 AI 自己做出的承诺和建议。但复杂的语义信息（如爱好、家人）需要启动后台 Worker 才能提取。**
