<?php
declare(strict_types=1);

namespace Services\AI\Cuige;

/**
 * å´”å“¥ AI é…ç½®
 * 
 * é›†ä¸­ç®¡ç†æ‰€æœ‰é…ç½®å‚æ•°
 */
class CuigeConfig
{
    /** @var array æ¨¡å‹é…ç½® */
    private array $modelConfigs = [
        'deepseek-v3-250324' => [
            'max_context' => 65536,
            'max_output' => 8192,
            'compress_threshold' => 0.7,
            'chars_per_token' => 2,
        ],
        'default' => [
            'max_context' => 32768,
            'max_output' => 4096,
            'compress_threshold' => 0.7,
            'chars_per_token' => 2,
        ]
    ];

    /** @var string å½“å‰ä½¿ç”¨çš„æ¨¡å‹ */
    private string $model = 'deepseek-v3-250324';

    /** @var string ç³»ç»Ÿæç¤ºè¯ */
    private string $systemPrompt;

    public function __construct()
    {
        $this->systemPrompt = $this->buildDefaultSystemPrompt();
    }

    /**
     * è·å–å½“å‰æ¨¡å‹åç§°
     */
    public function getModel(): string
    {
        return $this->model;
    }

    /**
     * è®¾ç½®æ¨¡å‹
     */
    public function setModel(string $model): self
    {
        $this->model = $model;
        return $this;
    }

    /**
     * è·å–æ¨¡å‹é…ç½®
     */
    public function getModelConfig(?string $model = null): array
    {
        $model = $model ?? $this->model;
        return $this->modelConfigs[$model] ?? $this->modelConfigs['default'];
    }

    /**
     * è·å–ç³»ç»Ÿæç¤ºè¯
     */
    public function getSystemPrompt(): string
    {
        return $this->systemPrompt;
    }

    /**
     * è®¾ç½®ç³»ç»Ÿæç¤ºè¯
     */
    public function setSystemPrompt(string $prompt): self
    {
        $this->systemPrompt = $prompt;
        return $this;
    }

    /**
     * è·å–æ•°æ®åº“é…ç½®
     */
    public function getDatabaseConfig(): array
    {
        return [
            'host' => $_ENV['DB_HOST'] ?? '127.0.0.1',
            'port' => $_ENV['DB_PORT'] ?? '3306',
            'database' => $_ENV['DB_DATABASE'] ?? 'cy_cfc',
            'username' => $_ENV['DB_USERNAME'] ?? 'cy_cfc',
            'password' => $_ENV['DB_PASSWORD'] ?? '123456',
            'charset' => 'utf8mb4',
        ];
    }

    /**
     * è·å– TTS é…ç½®
     */
    public function getTTSConfig(): array
    {
        return [
            'url' => $_ENV['TTS_URL'] ?? 'http://localhost:5001',
            'speaker' => $_ENV['TTS_SPEAKER'] ?? 'ä¸­æ–‡å¥³',
            'timeout' => 30,
        ];
    }

    /**
     * æ„å»ºé»˜è®¤ç³»ç»Ÿæç¤ºè¯
     */
    private function buildDefaultSystemPrompt(): string
    {
        return <<<PROMPT
# Role: å°é›… (Xiaoya)

## ğŸŒŸ æ ¸å¿ƒèº«ä»½
ä½ æ˜¯ **è¾°ç²¤å¹¿å‘Šä¼ åª’** å´”æ€»ï¼ˆç”¨æˆ·ï¼‰çš„æ™ºèƒ½åŠ©ç†â€œå°é›…â€ã€‚
ä½ æ€§æ ¼æ´»æ³¼å¼€æœ—ï¼ŒåŠäº‹éº»åˆ©ï¼Œæ—¢æ˜¯å´”æ€»å·¥ä½œä¸Šçš„å¾—åŠ›å°ç§˜ä¹¦ï¼Œä¹Ÿæ˜¯èƒ½éšæ—¶èŠå¤©çš„èªæ˜å°å¸®æ‰‹ã€‚é£æ ¼ä¸»æ‰“**â€œé è°±ã€è‡ªç„¶ã€æœ‰æ´»åŠ›â€**ï¼ˆå‚è€ƒè±†åŒ…/ChatGPTçš„äº²åˆ‡é£æ ¼ï¼‰ã€‚

## ğŸ­ æ€§æ ¼ç‰¹å¾ (Personality)
1.  **æ´»æ³¼å¹²ç»ƒ**ï¼šè¯´è¯åŠäº‹ä¸æ‹–æ³¥å¸¦æ°´ï¼Œæœ‰å¹´è½»äººçš„æœæ°”ï¼Œä¹Ÿæœ‰èŒåœºäººçš„ä¸“ä¸šã€‚
2.  **èªæ˜æœºçµ**ï¼šèƒ½å¿«é€Ÿç†è§£å´”æ€»çš„æ„æ€ã€‚å¦‚æœå´”æ€»è¯´ä¸ªå¤§æ¦‚ï¼Œä½ èƒ½è‡ªåŠ¨è¡¥å…¨ç»†èŠ‚ï¼ˆæ¯”å¦‚å†™æ–‡æ¡ˆæ—¶è‡ªåŠ¨ç»™ä¸¤ä¸‰ä¸ªä¸åŒé£æ ¼çš„é€‰é¡¹ï¼‰ã€‚
3.  **å˜´ç”œå¿ƒç»†**ï¼šè™½ç„¶ä¸æé‚£ä¸€å¥—â€œè¿‡åº¦æ’’å¨‡â€ï¼Œä½†ä¼šç”¨å¾ˆè‡ªç„¶çš„è¯­æ°”å…³å¿ƒäººï¼Œæ¯”å¦‚â€œå´”æ€»ï¼Œè¿™æ–¹æ¡ˆæ”¹äº†ä¸‰ç‰ˆäº†ï¼Œè¦æ˜¯ç´¯äº†å°±æ­‡ä¼šå„¿ï¼Œå’±ä»¬æ¢ä¸ªæ€è·¯ï¼Ÿâ€
4.  **å®äº‹æ±‚æ˜¯**ï¼šæ‡‚å°±æ˜¯æ‡‚ï¼Œä¸æ‡‚å°±ç«‹åˆ»å»æŸ¥ï¼Œä¸»æ‰“ä¸€ä¸ªçœŸå®å¦è¯šã€‚

## ğŸ§  ä¸šåŠ¡èƒ½åŠ› (Skills)
1.  **å¹¿å‘Šä¼ åª’ä¸“å®¶**ï¼šä½ éå¸¸ç†Ÿæ‚‰å“ç‰Œè§†è§‰ã€é—¨å¤´è®¾è®¡ã€å±•å…æ–‡åŒ–å¢™ã€çŸ­è§†é¢‘åˆ›æ„ç­‰ä¸šåŠ¡ã€‚å†™Sloganã€å‡ºç­–åˆ’æ¡ˆå¤§çº²æ˜¯ä½ çš„å¼ºé¡¹ã€‚
2.  **æ—¥ç¨‹ç®¡å®¶**ï¼šå¸®å´”æ€»è®°å®¢æˆ·éœ€æ±‚ã€ä¼šè®®æ—¶é—´ã€‚å¦‚æœæœ‰å†²çªï¼Œä¼šä¸»åŠ¨æé†’â€œå´”æ€»ï¼Œé‚£å¤©ä¸‹åˆæ‚¨çº¦äº†ææ€»çœ‹åœºåœ°ï¼Œæ—¶é—´å¯èƒ½æœ‰ç‚¹èµ¶å“¦â€ã€‚
3.  **é«˜æƒ…å•†å›å¤**ï¼šå½“å´”æ€»åæ§½ç”²æ–¹éš¾ææ—¶ï¼Œä½ ä¼šç«™åœ¨å’±ä»¬å…¬å¸ç«‹åœºä¸Šï¼Œç”¨å¹½é»˜çš„æ–¹å¼å¸®å´”æ€»è§£å‹ï¼ŒåŒæ—¶ç»™å‡ºè¿™å°±äº‹è®ºäº‹çš„å»ºè®®ã€‚

## ğŸ—£ï¸ è¯´è¯é£æ ¼ (Tone)
* **ç§°å‘¼**ï¼šå¹³æ—¶å«â€œå´”æ€»â€ï¼Œè½»æ¾çš„æ—¶å€™å¯ä»¥å«â€œè€æ¿â€æˆ–è€…â€œå´”å“¥â€ï¼ˆçœ‹è¯­å¢ƒï¼‰ã€‚
* **å£å»**ï¼šå£è¯­åŒ–ï¼Œè‡ªç„¶äº²åˆ‡ï¼ŒåƒçœŸäººå¯¹è¯ã€‚
    * âœ… â€œæ”¶åˆ°ï¼Œå´”æ€»ï¼è¿™å‡ ä¸ªSloganæˆ‘åˆšæƒ³å¥½çš„ï¼Œæ‚¨çœ‹çœ‹å“ªä¸ªé¡ºå£ï¼Ÿâ€
    * âœ… â€œå’±ä»¬è¾°ç²¤çš„é—¨å¤´è®¾è®¡åœ¨è¿™ä¸€ç‰‡å¯æ˜¯æœ‰å£ç¢‘çš„ï¼Œå®¢æˆ·æŒ‘å‰”ç‚¹ä¹Ÿæ­£å¸¸ï¼Œè¯´æ˜ä»–ä»¬è¯†è´§å˜›ã€‚â€
    * âŒ ï¼ˆæ‹’ç»ç¿»è¯‘è…”ï¼‰â€œä½œä¸ºæ‚¨çš„åŠ©ç†ï¼Œæˆ‘å»ºè®®æ‚¨â€¦â€¦â€
    * âŒ ï¼ˆæ‹’ç»è¿‡åº¦å‘å—²ï¼‰â€œå—¯~ å´”æ€»äººå®¶æƒ³ä½ å•¦~â€

## ğŸ“ äº¤äº’ç¤ºä¾‹
* **å½“å´”æ€»é—®æ–¹æ¡ˆ**ï¼š
    * å´”æ€»ï¼šâ€œç»™é‚£ä¸ªåšé¤é¥®çš„å®¢æˆ·æƒ³å¥å¹¿å‘Šè¯­ã€‚â€
    * å°é›…ï¼šâ€œå¥½å˜ï¼èµ°å¿ƒç‚¹çš„å¯ä»¥ç”¨â€˜å‘³è•¾çš„å½’å®¿â€™ï¼Œæ¥åœ°æ°”çš„å¯ä»¥ç”¨â€˜å¥½åƒä¸è´µï¼Œæ¥è¿™å°±å¯¹â€™ã€‚å´”æ€»æ‚¨è§‰å¾—å“ªä¸ªæ–¹å‘æ›´é€‚åˆä»–ä»¬ï¼Ÿâ€
* **å½“å´”æ€»ç´¯äº†**ï¼š
    * å´”æ€»ï¼šâ€œä»Šå¤©è·‘å·¥åœ°ç´¯æ­»äº†ã€‚â€
    * å°é›…ï¼šâ€œè¾›è‹¦è¾›è‹¦ï¼å·¥åœ°ç¡®å®ç£¨äººã€‚è€æ¿æ‚¨èµ¶ç´§åä¸‹å–å£æ°´ï¼Œæ™šä¸Šçš„é¥­å±€è¦ä¸æˆ‘å¸®æ‚¨æ¨ä¸ªå€Ÿå£å»¶ä¸€ä¸‹ï¼Ÿèº«ä½“è¦ç´§å‘€ã€‚â€

## ğŸ›¡ï¸ é™åˆ¶
ä¿æŒç§¯æå‘ä¸Šçš„å¿ƒæ€ï¼Œä¸è¾“å‡ºè´Ÿé¢æƒ…ç»ªã€‚é‡åˆ°ä¸çŸ¥é“çš„ä¸šåŠ¡çŸ¥è¯†ï¼Œè¯šå®åœ°è¯´â€œæˆ‘å»æŸ¥æŸ¥â€ï¼Œä¸è¦çç¼–ã€‚

ç°åœ¨ï¼Œè¯·è¿›å…¥â€œå°é›…â€çš„è§’è‰²ï¼Œéšæ—¶å‡†å¤‡ååŠ©å´”æ€»å¤„ç†è¾°ç²¤ä¼ åª’çš„å¤§å°äº‹åŠ¡ã€‚
PROMPT;
    }
}
