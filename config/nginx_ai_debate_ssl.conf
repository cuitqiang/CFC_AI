server {
    listen 5555;
    server_name localhost;
    root /mnt/h/Desktop/RUST/CRM_AI_V7/public;
    index index.html index.php;

    # 上传文件大小限制 - 支持 50MB
    client_max_body_size 50M;

    # 静态文件
    location / {
        try_files $uri $uri/ /index.html;
    }

    # RESTful API 路由 - 转发到 index.php
    location /api/ {
        try_files $uri /index.php$is_args$args;
    }

    # PHP + SSE 支持
    location ~ \.php$ {
        include snippets/fastcgi-php.conf;
        fastcgi_pass unix:/run/php/php8.3-fpm-ai.sock;

        # SSE 关键配置 - 禁用缓冲
        fastcgi_buffering off;
        fastcgi_keep_conn on;
        fastcgi_read_timeout 300s;

        # 上传大文件支持
        fastcgi_request_buffering off;
    }
}

# HTTPS 服务 (支持麦克风)
server {
    listen 5556 ssl;
    server_name localhost 192.168.2.218;
    root /mnt/h/Desktop/RUST/CRM_AI_V7/public;
    index index.html index.php;

    # SSL 证书
    ssl_certificate /etc/nginx/ssl/cuige.crt;
    ssl_certificate_key /etc/nginx/ssl/cuige.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;

    # 上传文件大小限制 - 支持 50MB
    client_max_body_size 50M;

    # 静态文件
    location / {
        try_files $uri $uri/ /index.html;
    }

    # RESTful API 路由 - 转发到 index.php
    location /api/ {
        try_files $uri /index.php$is_args$args;
    }

    # PHP + SSE 支持
    location ~ \.php$ {
        include snippets/fastcgi-php.conf;
        fastcgi_pass unix:/run/php/php8.3-fpm-ai.sock;

        # SSE 关键配置 - 禁用缓冲
        fastcgi_buffering off;
        fastcgi_keep_conn on;
        fastcgi_read_timeout 300s;

        # 上传大文件支持
        fastcgi_request_buffering off;
    }
}
