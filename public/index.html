<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸŒŸ é˜³å…‰ç¾¤èŠå®¤ - è¯­éŸ³+å›¾ç‰‡</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            display: flex;
            flex-direction: column;
            color: #333;
        }
        
        .header {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 50%, #fecfef 100%);
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #eee;
            color: #333;
        }
        .header h1 { font-size: 18px; display: flex; align-items: center; gap: 10px; color: #333; }
        .header .member-count { background: #4CAF50; padding: 3px 12px; border-radius: 12px; font-size: 12px; color: white; }
        
        .topic-bar {
            background: rgba(255,255,255,0.95);
            padding: 10px 20px;
            font-size: 14px;
            color: #e91e63;
            border-bottom: 1px solid #eee;
        }
        
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            background: linear-gradient(180deg, #ffecd2 0%, #fcb69f 100%);
        }
        
        .message {
            display: flex;
            gap: 10px;
            max-width: 85%;
            animation: slideIn 0.25s ease;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* å·¦ä¾§è§’è‰² */
        .message.zhi, .message.nuan, .message.gan, .message.le { align-self: flex-start; }
        /* å³ä¾§è§’è‰² */
        .message.meng, .message.wen, .message.shi, .message.you { align-self: flex-end; flex-direction: row-reverse; }
        /* å´”å“¥&ç”¨æˆ·å±…ä¸­ */
        .message.cuige, .message.user, .message.summary { align-self: center; max-width: 90%; }
        
        .avatar {
            width: 42px; height: 42px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            flex-shrink: 0;
            border: 2px solid #333;
        }
        
        .cuige .avatar { background: linear-gradient(135deg, #ffd700, #ff8c00); border-color: #ffd700; box-shadow: 0 0 15px rgba(255,215,0,0.4); }
        .user .avatar { background: linear-gradient(135deg, #00d4ff, #0099cc); border-color: #00d4ff; box-shadow: 0 0 15px rgba(0,212,255,0.4); }
        .zhi .avatar { background: linear-gradient(135deg, #667eea, #764ba2); }
        .nuan .avatar { background: linear-gradient(135deg, #f093fb, #f5576c); }
        .gan .avatar { background: linear-gradient(135deg, #4facfe, #00f2fe); }
        .le .avatar { background: linear-gradient(135deg, #43e97b, #38f9d7); }
        .meng .avatar { background: linear-gradient(135deg, #fa709a, #fee140); }
        .wen .avatar { background: linear-gradient(135deg, #a18cd1, #fbc2eb); }
        .shi .avatar { background: linear-gradient(135deg, #5ee7df, #b490ca); }
        .you .avatar { background: linear-gradient(135deg, #ff9a9e, #fecfef); }
        .summary .avatar { background: linear-gradient(135deg, #ffd700, #ff8c00); }
        
        .bubble-wrapper { display: flex; flex-direction: column; gap: 2px; }
        .sender-name { font-size: 11px; color: #666; padding: 0 8px; }
        .meng .sender-name, .wen .sender-name, .shi .sender-name, .you .sender-name { text-align: right; }
        .cuige .sender-name, .user .sender-name { text-align: center; }
        .cuige .sender-name { color: #ffd700; font-weight: bold; }
        .user .sender-name { color: #00d4ff; font-weight: bold; }
        
        .bubble {
            background: white;
            padding: 10px 14px;
            border-radius: 12px;
            font-size: 15px;
            line-height: 1.6;
            word-break: break-word;
            border: 1px solid #eee;
            color: #333;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .bubble img.shared-image {
            max-width: 200px;
            max-height: 150px;
            border-radius: 8px;
            margin-top: 8px;
            display: block;
        }
        .meng .bubble, .wen .bubble, .shi .bubble, .you .bubble { background: linear-gradient(135deg, #e0c3fc, #8ec5fc); }
        .cuige .bubble { background: linear-gradient(135deg, #fff9e6, #fff3cd); border: 2px solid #ffd700; }
        .user .bubble { background: linear-gradient(135deg, #e0f7fa, #b2ebf2); border: 2px solid #00d4ff; }
        .summary .bubble { background: linear-gradient(135deg, #fff9e6, #fff3cd); border: 2px solid #ffd700; text-align: center; }
        
        .typing-indicator {
            display: flex;
            gap: 10px;
            align-items: center;
            padding: 8px 15px;
            font-size: 12px;
            color: #666;
        }
        .typing-dots { display: flex; gap: 4px; }
        .typing-dots span { width: 6px; height: 6px; background: #666; border-radius: 50%; animation: typing 1.4s infinite; }
        .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
        .typing-dots span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-5px); }
        }
        
        .input-area {
            background: rgba(255,255,255,0.95);
            border-top: 1px solid #eee;
            padding: 12px 20px;
        }
        .quick-topics { display: flex; gap: 8px; margin-bottom: 10px; flex-wrap: wrap; }
        .quick-topic {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .quick-topic:hover { transform: scale(1.05); box-shadow: 0 4px 15px rgba(102,126,234,0.4); }
        
        /* å›¾ç‰‡é¢„è§ˆåŒº */
        .image-preview-area {
            display: none;
            margin-bottom: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 2px dashed #667eea;
        }
        .image-preview-area.has-image {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .image-preview-area img {
            max-width: 120px;
            max-height: 80px;
            border-radius: 8px;
            object-fit: cover;
        }
        .image-preview-info {
            flex: 1;
        }
        .image-preview-info .filename {
            font-size: 13px;
            color: #333;
            font-weight: 500;
        }
        .image-preview-info .analyzing {
            font-size: 12px;
            color: #667eea;
            margin-top: 4px;
        }
        .image-preview-info .analyzed {
            font-size: 12px;
            color: #4CAF50;
            margin-top: 4px;
        }
        .remove-image-btn {
            background: #ff5252;
            color: white;
            border: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .remove-image-btn:hover {
            background: #d32f2f;
        }
        
        .input-wrapper { display: flex; gap: 10px; align-items: flex-end; }
        .input-wrapper textarea {
            flex: 1;
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px 15px;
            font-size: 15px;
            resize: none;
            min-height: 42px;
            max-height: 100px;
            font-family: inherit;
            color: #333;
        }
        .input-wrapper textarea:focus { outline: none; border-color: #667eea; }
        .input-wrapper textarea::placeholder { color: #999; }
        
        .btn-group { display: flex; gap: 8px; align-items: center; }
        
        /* å›¾ç‰‡ä¸Šä¼ æŒ‰é’® */
        .image-btn {
            background: linear-gradient(135deg, #43e97b, #38f9d7);
            border: none;
            width: 42px;
            height: 42px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.2s;
        }
        .image-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(67,233,123,0.4);
        }
        .image-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        #imageInput { display: none; }
        
        .send-btn, .speak-btn, .voice-btn {
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .send-btn { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
        .send-btn:hover { transform: scale(1.05); box-shadow: 0 4px 15px rgba(102,126,234,0.4); }
        .send-btn:disabled { background: #ccc; cursor: not-allowed; }
        .speak-btn { background: linear-gradient(135deg, #f093fb, #f5576c); color: white; font-weight: bold; }
        .speak-btn:hover { transform: scale(1.05); box-shadow: 0 4px 15px rgba(240,147,251,0.4); }
        .speak-btn:disabled { background: #ccc; color: #888; cursor: not-allowed; }
        
        /* è¯­éŸ³æŒ‰é’® */
        .voice-btn {
            background: linear-gradient(135deg, #00d4ff, #0099cc);
            color: white;
            width: 42px;
            height: 42px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }
        .voice-btn:hover { transform: scale(1.05); box-shadow: 0 4px 15px rgba(0,212,255,0.4); }
        .voice-btn.active { background: linear-gradient(135deg, #ff5252, #d32f2f); animation: pulse 1s infinite; }
        .voice-btn:disabled { background: #ccc; cursor: not-allowed; }
        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(255,82,82,0.4); }
            50% { box-shadow: 0 0 0 10px rgba(255,82,82,0); }
        }
        
        /* è¯­éŸ³çŠ¶æ€æŒ‡ç¤ºå™¨ */
        .voice-status {
            position: fixed;
            top: 80px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            display: none;
            align-items: center;
            gap: 8px;
            z-index: 100;
        }
        .voice-status.active { display: flex; }
        .voice-status .wave {
            display: flex;
            align-items: center;
            gap: 2px;
        }
        .voice-status .wave span {
            width: 3px;
            background: #00d4ff;
            border-radius: 2px;
            animation: wave 0.5s ease-in-out infinite;
        }
        .voice-status .wave span:nth-child(1) { height: 8px; animation-delay: 0s; }
        .voice-status .wave span:nth-child(2) { height: 12px; animation-delay: 0.1s; }
        .voice-status .wave span:nth-child(3) { height: 16px; animation-delay: 0.2s; }
        .voice-status .wave span:nth-child(4) { height: 12px; animation-delay: 0.3s; }
        .voice-status .wave span:nth-child(5) { height: 8px; animation-delay: 0.4s; }
        @keyframes wave {
            0%, 100% { transform: scaleY(1); }
            50% { transform: scaleY(1.5); }
        }
        
        .system-msg { text-align: center; color: #666; font-size: 12px; padding: 8px; background: rgba(255,255,255,0.5); border-radius: 20px; margin: 5px auto; max-width: 80%; }
        .system-msg .highlight { color: #e91e63; font-weight: bold; }
        
        /* å›¾ç‰‡æ¶ˆæ¯æ ·å¼ */
        .image-msg {
            text-align: center;
            padding: 15px;
            background: rgba(255,255,255,0.7);
            border-radius: 15px;
            margin: 10px auto;
            max-width: 300px;
        }
        .image-msg img {
            max-width: 100%;
            max-height: 200px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .image-msg .caption {
            margin-top: 10px;
            font-size: 13px;
            color: #666;
        }
    </style>
</head>
<body>
    <!-- è¯­éŸ³çŠ¶æ€æŒ‡ç¤ºå™¨ -->
    <div class="voice-status" id="voiceStatus">
        <div class="wave">
            <span></span><span></span><span></span><span></span><span></span>
        </div>
        <span id="voiceStatusText">è¯­éŸ³æ’­æ”¾ä¸­...</span>
    </div>
    
    <div class="header">
        <h1>âœ¨ AI ç•…èŠç¾¤ Â· è¯­éŸ³+å›¾ç‰‡</h1>
        <span class="member-count">ğŸ’¬ 8äººç•…èŠ</span>
    </div>
    
    <div class="topic-bar">
        ğŸ“¢ <strong>è¯é¢˜ï¼š</strong><span id="currentTopic">ç­‰å¾…å¼€èŠ...</span>
    </div>
    
    <div class="chat-container" id="chatContainer">
        <div class="system-msg">âœ¨ æ¬¢è¿æ¥åˆ°å´”å“¥çš„ç•…èŠç©ºé—´</div>
        <div class="system-msg">è¾“å…¥è¯é¢˜æˆ– <span class="highlight">ä¸Šä¼ å›¾ç‰‡</span> å¼€èŠï¼ŒAI ä»¬ä¼šä¸€èµ·è®¨è®ºï¼</div>
    </div>
    
    <div class="input-area">
        <div class="quick-topics">
            <span class="quick-topic" onclick="setTopic(this)">å¦‚ä½•ä¿æŒç§¯æå¿ƒæ€</span>
            <span class="quick-topic" onclick="setTopic(this)">æ€æ ·æå‡è‡ªå·±</span>
            <span class="quick-topic" onclick="setTopic(this)">AIèƒ½å¸¦æ¥ä»€ä¹ˆå¥½å¤„</span>
            <span class="quick-topic" onclick="setTopic(this)">å¦‚ä½•å¹³è¡¡å·¥ä½œç”Ÿæ´»</span>
        </div>
        
        <!-- å›¾ç‰‡é¢„è§ˆåŒº -->
        <div class="image-preview-area" id="imagePreview">
            <img id="previewImg" src="" alt="é¢„è§ˆ">
            <div class="image-preview-info">
                <div class="filename" id="previewFilename"></div>
                <div class="analyzing" id="previewStatus">ğŸ” AI æ­£åœ¨è¯†åˆ«å›¾ç‰‡...</div>
            </div>
            <button class="remove-image-btn" onclick="removeImage()">âœ•</button>
        </div>
        
        <div class="input-wrapper">
            <textarea id="topicInput" placeholder="è¾“å…¥è¯é¢˜ï¼Œæˆ–ä¸Šä¼ å›¾ç‰‡è®© AI ä»¬è®¨è®º..." rows="1" 
                onkeydown="handleKey(event)"></textarea>
            <div class="btn-group">
                <input type="file" id="imageInput" accept="image/*" onchange="handleImageSelect(event)">
                <button class="image-btn" id="imageBtn" onclick="document.getElementById('imageInput').click()" title="ä¸Šä¼ å›¾ç‰‡">ğŸ“·</button>
                <button class="voice-btn" id="voiceBtn" onclick="toggleVoice()" title="è¯­éŸ³æ’­æ”¾">ğŸ”Š</button>
                <button class="speak-btn" id="speakBtn" onclick="userSpeak()" disabled>å‚ä¸</button>
                <button class="send-btn" id="sendBtn" onclick="startDebate()">å¼€èŠ</button>
            </div>
        </div>
    </div>

    <script>
        const chatContainer = document.getElementById('chatContainer');
        const topicInput = document.getElementById('topicInput');
        const sendBtn = document.getElementById('sendBtn');
        const speakBtn = document.getElementById('speakBtn');
        const imageBtn = document.getElementById('imageBtn');
        const imageInput = document.getElementById('imageInput');
        const imagePreview = document.getElementById('imagePreview');
        const previewImg = document.getElementById('previewImg');
        const previewFilename = document.getElementById('previewFilename');
        const previewStatus = document.getElementById('previewStatus');
        const currentTopicEl = document.getElementById('currentTopic');
        const voiceBtn = document.getElementById('voiceBtn');
        const voiceStatus = document.getElementById('voiceStatus');
        const voiceStatusText = document.getElementById('voiceStatusText');
        
        let eventSource = null;
        let isDebating = false;
        let currentTopic = '';
        let sessionId = '';
        let selectedImage = null;  // å­˜å‚¨é€‰ä¸­çš„å›¾ç‰‡æ–‡ä»¶
        let imageAnalysis = null;  // å­˜å‚¨å›¾ç‰‡åˆ†æç»“æœ
        
        // ========== è¯­éŸ³ç³»ç»Ÿ V4 (æµå¼æ’­æ”¾ + å®æ—¶) ==========
        // TTS API åœ°å€
        const TTS_API_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? 'http://localhost:5001'
            : `http://${window.location.hostname}:5001`;
        
        let voiceEnabled = false;
        let audioContext = null;
        let isPlaying = false;
        let audioUnlocked = false;
        let voiceQueue = [];      // å¾…å¤„ç†çš„è¯­éŸ³è¯·æ±‚
        let currentSource = null; // å½“å‰æ’­æ”¾æº
        
        // åˆ†å¥è¿½è¸ª
        let sentenceTracker = new Map();
        const SENTENCE_END = /[ã€‚ï¼ï¼Ÿ!?.â€¦ï¼›;]+/g;
        
        // è§’è‰²è¯­é€Ÿ
        const agentVoiceConfig = {
            cuige: { speed: 1.4 },
            zhi: { speed: 1.3 },
            nuan: { speed: 1.25 },
            gan: { speed: 1.4 },
            le: { speed: 1.35 },
            meng: { speed: 1.3 },
            wen: { speed: 1.25 },
            shi: { speed: 1.3 },
            you: { speed: 1.25 },
            summary: { speed: 1.2 }
        };
        
        function initAudioContext() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
            return audioContext;
        }
        
        async function unlockAudio() {
            if (audioUnlocked) return;
            try {
                const ctx = initAudioContext();
                const buffer = ctx.createBuffer(1, 1, 22050);
                const source = ctx.createBufferSource();
                source.buffer = buffer;
                source.connect(ctx.destination);
                source.start(0);
                audioUnlocked = true;
                console.log('ğŸ“± éŸ³é¢‘å·²è§£é”');
            } catch (e) {}
        }
        
        async function toggleVoice() {
            await unlockAudio();
            voiceEnabled = !voiceEnabled;
            voiceBtn.classList.toggle('active', voiceEnabled);
            voiceBtn.innerHTML = voiceEnabled ? 'ğŸ”Š' : 'ğŸ”‡';
            voiceBtn.title = voiceEnabled ? 'å…³é—­è¯­éŸ³' : 'å¼€å¯è¯­éŸ³';
            
            if (!voiceEnabled) {
                voiceQueue = [];
                sentenceTracker.clear();
                isPlaying = false;
                if (currentSource) {
                    try { currentSource.stop(); } catch(e) {}
                }
                voiceStatus.classList.remove('active');
            }
            console.log(voiceEnabled ? 'ğŸ”Š è¯­éŸ³å¼€å¯' : 'ğŸ”‡ è¯­éŸ³å…³é—­');
        }
        
        // æ£€æµ‹æ–°å¥å­å¹¶åŠ å…¥é˜Ÿåˆ—
        function checkAndQueueSentence(agentId, fullText) {
            if (!voiceEnabled || !fullText) return;
            
            if (!sentenceTracker.has(agentId)) {
                sentenceTracker.set(agentId, { lastIndex: 0, count: 0 });
            }
            const tracker = sentenceTracker.get(agentId);
            const remaining = fullText.slice(tracker.lastIndex);
            const match = remaining.match(SENTENCE_END);
            
            if (match) {
                const endPos = remaining.indexOf(match[0]) + match[0].length;
                const sentence = remaining.slice(0, endPos).trim();
                
                if (sentence.length >= 4) {
                    tracker.count++;
                    tracker.lastIndex += endPos;
                    
                    // åŠ å…¥è¯­éŸ³é˜Ÿåˆ—
                    voiceQueue.push({ text: sentence, agentId, seq: tracker.count });
                    
                    // å¼€å§‹å¤„ç†é˜Ÿåˆ—
                    if (!isPlaying) {
                        processVoiceQueue();
                    }
                }
            }
        }
        
        // å¤„ç†å‰©ä½™æ–‡æœ¬
        function flushRemainingSentence(agentId, fullText) {
            if (!voiceEnabled) return;
            const tracker = sentenceTracker.get(agentId);
            if (!tracker) return;
            
            const remaining = fullText.slice(tracker.lastIndex).trim();
            if (remaining.length >= 3) {
                tracker.count++;
                voiceQueue.push({ text: remaining, agentId, seq: tracker.count });
                if (!isPlaying) processVoiceQueue();
            }
            sentenceTracker.delete(agentId);
        }
        
        // å¤„ç†è¯­éŸ³é˜Ÿåˆ— - æµå¼æ’­æ”¾
        async function processVoiceQueue() {
            if (voiceQueue.length === 0 || !voiceEnabled) {
                isPlaying = false;
                voiceStatus.classList.remove('active');
                return;
            }
            
            isPlaying = true;
            const { text, agentId, seq } = voiceQueue.shift();
            const config = agentVoiceConfig[agentId] || { speed: 1.3 };
            const agentName = agents[agentId]?.name || agentId;
            
            voiceStatus.classList.add('active');
            voiceStatusText.textContent = `${agentName} è¯´è¯ä¸­...`;
            
            try {
                // ä½¿ç”¨æµå¼ API
                const response = await fetch(`${TTS_API_URL}/tts/stream`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text, speed: config.speed })
                });
                
                if (!response.ok) throw new Error('TTS å¤±è´¥');
                
                const sampleRate = parseInt(response.headers.get('X-Sample-Rate') || '24000');
                const reader = response.body.getReader();
                const chunks = [];
                
                // è¯»å–æ‰€æœ‰ PCM æ•°æ®
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    chunks.push(value);
                }
                
                // åˆå¹¶å¹¶è½¬æ¢ä¸º AudioBuffer
                const totalLength = chunks.reduce((acc, c) => acc + c.length, 0);
                const pcmData = new Uint8Array(totalLength);
                let offset = 0;
                for (const chunk of chunks) {
                    pcmData.set(chunk, offset);
                    offset += chunk.length;
                }
                
                // PCM16 -> Float32
                const int16 = new Int16Array(pcmData.buffer);
                const float32 = new Float32Array(int16.length);
                for (let i = 0; i < int16.length; i++) {
                    float32[i] = int16[i] / 32768;
                }
                
                // åˆ›å»º AudioBuffer å¹¶æ’­æ”¾
                const ctx = initAudioContext();
                const audioBuffer = ctx.createBuffer(1, float32.length, sampleRate);
                audioBuffer.getChannelData(0).set(float32);
                
                currentSource = ctx.createBufferSource();
                currentSource.buffer = audioBuffer;
                currentSource.connect(ctx.destination);
                currentSource.onended = () => {
                    currentSource = null;
                    processVoiceQueue();
                };
                currentSource.start();
                
                console.log(`ğŸµ æ’­æ”¾å¥å­${seq}: ${text.slice(0,10)}...`);
                
            } catch (err) {
                console.error('è¯­éŸ³æ’­æ”¾å¤±è´¥:', err);
                processVoiceQueue();
            }
        }
        
        async function checkTTSService() {
            try {
                const response = await fetch(`${TTS_API_URL}/`);
                const data = await response.json();
                if (data.status === 'ok') {
                    console.log('âœ… TTS æœåŠ¡å¯ç”¨');
                    voiceBtn.disabled = false;
                }
            } catch (error) {
                console.log('âš ï¸ TTS æœåŠ¡ä¸å¯ç”¨');
                voiceBtn.disabled = true;
            }
        }
        
        checkTTSService();
        
        const agents = {
            cuige: { name: 'ğŸ‘‘å´”å“¥(ç¾¤ä¸»)', emoji: 'ğŸ‘‘' },
            user: { name: 'ğŸŒŸæˆ‘', emoji: 'ğŸŒŸ' },
            zhi: { name: 'æ™ºæ…§å¯¼å¸ˆ', emoji: 'ğŸ’¡' },
            nuan: { name: 'æš–å¿ƒå§å§', emoji: 'ğŸ¤—' },
            gan: { name: 'çƒ­è¡€é’å¹´', emoji: 'ğŸ’ª' },
            le: { name: 'å¼€å¿ƒæœ', emoji: 'ğŸ˜„' },
            meng: { name: 'æ¢¦æƒ³å®¶', emoji: 'ğŸŒˆ' },
            wen: { name: 'æ–‡è‰ºé’å¹´', emoji: 'ğŸ­' },
            shi: { name: 'ç†æ€§æ´¾', emoji: 'ğŸ”' },
            you: { name: 'çŸ¥å¿ƒå¥½å‹', emoji: 'ğŸ˜Š' },
            summary: { name: 'ğŸ‘‘å´”å“¥æ€»ç»“', emoji: 'ğŸ‘‘' }
        };
        
        function setTopic(el) { topicInput.value = el.textContent; topicInput.focus(); }
        function scrollToBottom() { chatContainer.scrollTop = chatContainer.scrollHeight; }
        
        function handleKey(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                if (isDebating) userSpeak();
                else startDebate();
            }
        }
        
        // å¤„ç†å›¾ç‰‡é€‰æ‹©
        async function handleImageSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // éªŒè¯æ–‡ä»¶ç±»å‹
            if (!file.type.startsWith('image/')) {
                alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
                return;
            }
            
            // éªŒè¯æ–‡ä»¶å¤§å° (10MB)
            if (file.size > 10 * 1024 * 1024) {
                alert('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡ 10MB');
                return;
            }
            
            selectedImage = file;
            imageAnalysis = null;
            
            // æ˜¾ç¤ºé¢„è§ˆ
            const reader = new FileReader();
            reader.onload = function(e) {
                previewImg.src = e.target.result;
                previewFilename.textContent = file.name;
                previewStatus.textContent = 'ğŸ” AI æ­£åœ¨è¯†åˆ«å›¾ç‰‡...';
                previewStatus.className = 'analyzing';
                imagePreview.classList.add('has-image');
            };
            reader.readAsDataURL(file);
            
            // åˆ†æå›¾ç‰‡
            await analyzeImage(file);
        }
        
        // åˆ†æå›¾ç‰‡
        async function analyzeImage(file) {
            try {
                const formData = new FormData();
                formData.append('image', file);
                
                const response = await fetch('/api/debate/analyze-image', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    imageAnalysis = result.data;
                    previewStatus.textContent = 'âœ… è¯†åˆ«å®Œæˆ: ' + (imageAnalysis.description || '').substring(0, 30) + '...';
                    previewStatus.className = 'analyzed';
                    
                    // å¦‚æœè¾“å…¥æ¡†ä¸ºç©ºï¼Œè‡ªåŠ¨å¡«å……æ¨èè¯é¢˜
                    if (!topicInput.value.trim() && imageAnalysis.topics && imageAnalysis.topics.length > 0) {
                        topicInput.placeholder = 'æ¨èè¯é¢˜: ' + imageAnalysis.topics[0];
                    }
                } else {
                    previewStatus.textContent = 'âš ï¸ è¯†åˆ«å¤±è´¥ï¼Œä½†ä»å¯å‘é€';
                    previewStatus.className = 'analyzing';
                }
            } catch (error) {
                console.error('å›¾ç‰‡åˆ†æå¤±è´¥:', error);
                previewStatus.textContent = 'âš ï¸ è¯†åˆ«å¤±è´¥ï¼Œä½†ä»å¯å‘é€';
                previewStatus.className = 'analyzing';
            }
        }
        
        // ç§»é™¤å›¾ç‰‡
        function removeImage() {
            selectedImage = null;
            imageAnalysis = null;
            imageInput.value = '';
            imagePreview.classList.remove('has-image');
            previewImg.src = '';
            topicInput.placeholder = 'è¾“å…¥è¯é¢˜ï¼Œæˆ–ä¸Šä¼ å›¾ç‰‡è®© AI ä»¬è®¨è®º...';
        }
        
        function addSystemMsg(text) {
            const div = document.createElement('div');
            div.className = 'system-msg';
            div.innerHTML = text;
            chatContainer.appendChild(div);
            scrollToBottom();
        }
        
        // æ·»åŠ å›¾ç‰‡æ¶ˆæ¯
        function addImageMsg(imageUrl, caption) {
            const div = document.createElement('div');
            div.className = 'image-msg';
            div.innerHTML = `
                <img src="${imageUrl}" alt="åˆ†äº«çš„å›¾ç‰‡">
                <div class="caption">${caption}</div>
            `;
            chatContainer.appendChild(div);
            scrollToBottom();
        }
        
        function showTyping(agentId) {
            removeTyping(agentId);
            const agent = agents[agentId] || { name: agentId, emoji: 'ğŸ’¬' };
            const div = document.createElement('div');
            div.className = `typing-indicator typing-${agentId}`;
            div.innerHTML = `<span>${agent.emoji} ${agent.name} æ­£åœ¨è¾“å…¥</span><div class="typing-dots"><span></span><span></span><span></span></div>`;
            chatContainer.appendChild(div);
            scrollToBottom();
        }
        
        function removeTyping(agentId) {
            const el = chatContainer.querySelector(`.typing-${agentId}`);
            if (el) el.remove();
        }
        
        function addMessage(agentId, content, append = false) {
            removeTyping(agentId);
            const agent = agents[agentId] || { name: agentId, emoji: 'ğŸ’¬' };
            let msgEl = chatContainer.querySelector(`.message.${agentId}.building`);
            
            if (!msgEl) {
                msgEl = document.createElement('div');
                msgEl.className = `message ${agentId} building`;
                msgEl.innerHTML = `
                    <div class="avatar">${agent.emoji}</div>
                    <div class="bubble-wrapper">
                        <span class="sender-name">${agent.name}</span>
                        <div class="bubble"></div>
                    </div>
                `;
                chatContainer.appendChild(msgEl);
            }
            
            const bubble = msgEl.querySelector('.bubble');
            bubble.innerHTML = append ? bubble.innerHTML + content : content;
            scrollToBottom();
        }
        
        function completeMsg(agentId) {
            const el = chatContainer.querySelector(`.message.${agentId}.building`);
            if (el) el.classList.remove('building');
        }
        
        // ç”¨æˆ·æ’å˜´
        function userSpeak() {
            const msg = topicInput.value.trim();
            if (!msg || !isDebating || !sessionId) return;
            
            addMessage('user', msg);
            completeMsg('user');
            
            console.log('ç”¨æˆ·å‘è¨€:', msg);
            topicInput.value = '';
        }
        
        // å¼€å§‹è®¨è®º
        async function startDebate() {
            const topic = topicInput.value.trim();
            
            // å¿…é¡»æœ‰è¯é¢˜æˆ–å›¾ç‰‡
            if (!topic && !selectedImage) {
                alert('è¯·è¾“å…¥è¯é¢˜æˆ–ä¸Šä¼ å›¾ç‰‡');
                return;
            }
            
            if (isDebating) return;
            
            isDebating = true;
            sessionId = 's' + Date.now() + Math.random().toString(36).substr(2, 9);
            sendBtn.disabled = true;
            sendBtn.textContent = 'ç•…èŠä¸­...';
            imageBtn.disabled = true;
            speakBtn.disabled = false;
            
            // æ¸…ç©ºèŠå¤©åŒº
            chatContainer.querySelectorAll('.message, .typing-indicator, .image-msg').forEach(m => m.remove());
            
            // å¦‚æœæœ‰å›¾ç‰‡ï¼Œæ˜¾ç¤ºå›¾ç‰‡æ¶ˆæ¯
            if (selectedImage && previewImg.src) {
                addImageMsg(previewImg.src, 'ğŸ“· æˆ‘åˆ†äº«äº†ä¸€å¼ å›¾ç‰‡');
            }
            
            // è®¾ç½®è¯é¢˜æ˜¾ç¤º
            const displayTopic = topic || (imageAnalysis?.description?.substring(0, 50) + '...' || 'çœ‹çœ‹è¿™å¼ å›¾ç‰‡');
            currentTopic = displayTopic;
            currentTopicEl.textContent = displayTopic;
            addSystemMsg(`âœ¨ <span class="highlight">${displayTopic}</span> Â· å¼€å§‹è®¨è®ºï¼`);
            
            // å¦‚æœæœ‰å›¾ç‰‡ï¼Œä½¿ç”¨å¸¦å›¾ç‰‡çš„æ¥å£
            if (selectedImage) {
                await startDebateWithImage(topic);
            } else {
                startDebateText(topic);
            }
            
            // æ¸…ç©ºè¾“å…¥
            topicInput.value = '';
            topicInput.placeholder = 'è¾“å…¥ä½ çš„è§‚ç‚¹å‚ä¸è®¨è®º...';
            removeImage();
        }
        
        // çº¯æ–‡å­—è®¨è®º
        function startDebateText(topic) {
            eventSource = new EventSource(`/api/debate/stream?topic=${encodeURIComponent(topic)}&mode=chat`);
            setupEventSource();
        }
        
        // å¸¦å›¾ç‰‡çš„è®¨è®º
        async function startDebateWithImage(topic) {
            // ä½¿ç”¨ POST + FormData å‘é€å›¾ç‰‡
            const formData = new FormData();
            formData.append('image', selectedImage);
            formData.append('topic', topic || '');
            formData.append('mode', 'chat');
            
            try {
                const response = await fetch('/api/debate/stream-with-image', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error('è¯·æ±‚å¤±è´¥');
                }
                
                // è¯»å– SSE æµ
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    buffer += decoder.decode(value, { stream: true });
                    
                    // å¤„ç† SSE æ•°æ®
                    const lines = buffer.split('\n');
                    buffer = lines.pop() || '';
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const dataStr = line.slice(6);
                            if (dataStr === '[DONE]') continue;
                            
                            try {
                                const data = JSON.parse(dataStr);
                                handleSSEData(data);
                            } catch (e) {
                                console.error('è§£æ SSE æ•°æ®å¤±è´¥:', e);
                            }
                        }
                    }
                }
                
                endDebate();
                addSystemMsg('ğŸ‰ è®¨è®ºç»“æŸï¼ŒæœŸå¾…ä¸‹æ¬¡äº¤æµï¼');
                
            } catch (error) {
                console.error('è¯·æ±‚å¤±è´¥:', error);
                addSystemMsg('âš ï¸ è¿æ¥å¤±è´¥ï¼Œè¯·é‡è¯•');
                endDebate();
            }
        }
        
        // è®¾ç½® EventSource äº‹ä»¶å¤„ç†
        function setupEventSource() {
            eventSource.onmessage = function(e) {
                try {
                    const data = JSON.parse(e.data);
                    handleSSEData(data);
                } catch (err) { 
                    console.error(err); 
                }
            };
            
            eventSource.onerror = function() { 
                endDebate(); 
            };
        }
        
        // å¤„ç† SSE æ•°æ®
        function handleSSEData(data) {
            if (data.type === 'thinking') {
                showTyping(data.agent);
            } else if (data.type === 'chunk') {
                addMessage(data.agent, data.content, true);
                // å®æ—¶æ£€æŸ¥æ–°å¥å­
                if (voiceEnabled) {
                    const msgEl = chatContainer.querySelector(`.message.${data.agent}.building .bubble`);
                    if (msgEl) {
                        checkAndQueueSentence(data.agent, msgEl.textContent);
                    }
                }
            } else if (data.type === 'complete') {
                completeMsg(data.agent);
                // å¤„ç†å‰©ä½™æ–‡æœ¬
                if (voiceEnabled) {
                    const msgEl = chatContainer.querySelector(`.message.${data.agent}:not(.building) .bubble`);
                    if (msgEl) {
                        flushRemainingSentence(data.agent, msgEl.textContent);
                    }
                }
            } else if (data.type === 'summary') {
                addMessage('summary', data.content);
                completeMsg('summary');
                if (voiceEnabled) {
                    voiceQueue.push({ text: data.content, agentId: 'summary', seq: 1 });
                    if (!isPlaying) processVoiceQueue();
                }
            } else if (data.type === 'image_analyzed') {
                addSystemMsg(`ğŸ–¼ï¸ AI å·²ç†è§£å›¾ç‰‡å†…å®¹`);
            } else if (data.type === 'done') {
                endDebate();
                addSystemMsg('ğŸ‰ è®¨è®ºç»“æŸï¼ŒæœŸå¾…ä¸‹æ¬¡äº¤æµï¼');
            } else if (data.type === 'error') {
                addSystemMsg('âš ï¸ ' + data.message);
                endDebate();
            }
        }
        
        function endDebate() {
            if (eventSource) { 
                eventSource.close(); 
                eventSource = null; 
            }
            isDebating = false;
            sessionId = '';
            sendBtn.disabled = false;
            sendBtn.textContent = 'å¼€èŠ';
            imageBtn.disabled = false;
            speakBtn.disabled = true;
            topicInput.placeholder = 'è¾“å…¥è¯é¢˜ï¼Œæˆ–ä¸Šä¼ å›¾ç‰‡è®© AI ä»¬è®¨è®º...';
        }
        
        topicInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 100) + 'px';
        });
    </script>
</body>
</html>
